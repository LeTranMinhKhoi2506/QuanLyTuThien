@using Microsoft.AspNetCore.Http
@model TuThien.Models.Campaign

@{
    ViewData["Title"] = Model.Title;
    Layout = "~/Views/Shared/_CampaignLayout.cshtml";
    
    var thumb = string.IsNullOrEmpty(Model.ThumbnailUrl) ? Url.Content("~/Images/DefaultPic.png") : Model.ThumbnailUrl;
    decimal current = Model.CurrentAmount ?? 0m;
    decimal target = Model.TargetAmount;
    int percent = target > 0 ? (int)System.Math.Min(100, System.Math.Round((current / target) * 100)) : 0;
    
    var daysLeft = Model.EndDate.HasValue ? (Model.EndDate.Value - DateTime.Now).Days : 0;
    // Đếm số người quyên góp duy nhất (unique donors)
    var successfulDonationsList = Model.Donations?.Where(d => d.PaymentStatus == "success" || d.PaymentStatus == "completed").ToList() ?? new List<TuThien.Models.Donation>();
    var donorCount = successfulDonationsList
        .GroupBy(d => new { d.UserId, IsAnonymous = d.IsAnonymous == true })
        .Count();
}

<link rel="stylesheet" href="~/css/CampaignDetails.css" asp-append-version="true" />

<div class="campaign-details-page">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="/Campaign/MyCampaigns">Chiến dịch của tôi</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Title</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Campaign Header -->
            <div class="campaign-header-section mb-4">
                @if (Model.Category != null)
                {
                    <span class="category-badge">
                        <i class="bi bi-tag-fill me-1"></i>@Model.Category.Name
                    </span>
                }
                <h1 class="campaign-main-title">@Model.Title</h1>
                
                <div class="campaign-meta d-flex align-items-center gap-4 mt-3">
                    <div class="meta-item">
                        <i class="bi bi-person-circle me-2"></i>
                        <span>Bởi <strong>@Model.Creator?.Username</strong></span>
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-calendar-event me-2"></i>
                        <span>@Model.CreatedAt?.ToString("dd/MM/yyyy")</span>
                    </div>
                </div>
            </div>

            <!-- Campaign Image -->
            <div class="campaign-main-image mb-4">
                <img src="@thumb" alt="@Model.Title" class="img-fluid rounded-3 shadow" 
                     onerror="this.src='@Url.Content("~/Images/DefaultPic.png")'" />
            </div>

            <!-- Campaign Tabs -->
            <div class="campaign-tabs mb-4">
                <ul class="nav nav-tabs" id="campaignTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="story-tab" data-bs-toggle="tab" data-bs-target="#story" type="button">
                            <i class="bi bi-book me-2"></i>Câu chuyện
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="statistics-tab" data-bs-toggle="tab" data-bs-target="#statistics" type="button">
                            <i class="bi bi-graph-up me-2"></i>Bảng thống kê
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="donors-tab" data-bs-toggle="tab" data-bs-target="#donors" type="button">
                            <i class="bi bi-people me-2"></i>Nhà quyên góp <span class="badge bg-primary ms-1">@donorCount</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" type="button">
                            <i class="bi bi-chat-dots me-2"></i>Bình luận <span class="badge bg-primary ms-1">@Model.Comments?.Count</span>
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="campaignTabContent">
                    <!-- Story Tab -->
                    <div class="tab-pane fade show active" id="story" role="tabpanel">
                        <div class="story-content">
                            <h3 class="section-title">Về chiến dịch này</h3>
                            <div class="story-text">
                                @Html.Raw(Model.Description?.Replace("\n", "<br/>"))
                            </div>

                            @if (Model.CampaignMilestones?.Any() == true)
                            {
                                <div class="milestones-section mt-5">
                                    <h3 class="section-title">Mốc quan trọng</h3>
                                    <div class="timeline">
                                        @{
                                            var milestones = Model.CampaignMilestones.OrderBy(m => m.MilestoneId).ToList();
                                            bool allPreviousCompleted = true;
                                            decimal cumulativeAmount = 0;
                                            
                                            for (int i = 0; i < milestones.Count; i++)
                                            {
                                                var milestone = milestones[i];
                                                var milestoneNumber = i + 1;
                                                cumulativeAmount += milestone.AmountNeeded;
                                                bool isReached = current >= cumulativeAmount && allPreviousCompleted;
                                                
                                                string status = "locked";
                                                if (isReached)
                                                {
                                                    status = "completed";
                                                }
                                                else if (allPreviousCompleted)
                                                {
                                                    status = "active";
                                                }
                                                
                                                if (!isReached)
                                                {
                                                    allPreviousCompleted = false;
                                                }
                                                
                                                <div class="timeline-item @status">
                                                    <div class="timeline-marker">
                                                        @if (status == "completed")
                                                        {
                                                            <i class="bi bi-check-circle-fill"></i>
                                                        }
                                                        else if (status == "active")
                                                        {
                                                            <i class="bi bi-circle-half"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="bi bi-lock-fill"></i>
                                                        }
                                                    </div>
                                                    <div class="timeline-content">
                                                        <div class="milestone-badge milestone-badge-@status">
                                                            Mốc @milestoneNumber
                                                        </div>
                                                        <h5>@milestone.Title</h5>
                                                        <p class="text-muted mb-2">
                                                            <strong>Mục tiêu: @String.Format("{0:N0}", milestone.AmountNeeded) ₫</strong>
                                                        </p>
                                                        <p class="text-muted mb-2">
                                                            <i class="bi bi-piggy-bank"></i> 
                                                            Tổng cần: <strong>@String.Format("{0:N0}", cumulativeAmount) ₫</strong>
                                                        </p>
                                                        
                                                        @if (milestone.Deadline.HasValue)
                                                        {
                                                            <p class="text-muted mb-2">
                                                                <i class="bi bi-calendar3"></i> 
                                                                Deadline: @milestone.Deadline.Value.ToString("dd/MM/yyyy")
                                                            </p>
                                                        }
                                                     
                                                        @if (status == "completed")
                                                        {
                                                            <span class="badge bg-success mt-2">
                                                                <i class="bi bi-check2"></i> Đã đạt được
                                                            </span>
                                                        }
                                                        else if (status == "active")
                                                        {
                                                            var remaining = cumulativeAmount - current;
                                                            var progressPercent = current > 0 && cumulativeAmount > 0 
                                                                ? (int)((current / cumulativeAmount) * 100) 
                                                                : 0;
                                                            
                                                            <div class="milestone-progress mt-2">
                                                                <div class="progress mb-2" style="height: 8px;">
                                                                    <div class="progress-bar bg-warning" role="progressbar" 
                                                                         style="width: @progressPercent%"></div>
                                                                </div>
                                                                <span class="badge bg-warning text-dark">
                                                                    <i class="bi bi-hourglass-split"></i> Đang quyên góp - Còn @String.Format("{0:N0}", remaining) ₫
                                                                </span>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary mt-2">
                                                                <i class="bi bi-lock"></i> Chưa mở khóa
                                                            </span>
                                                            <p class="text-muted small mt-2 mb-0">
                                                                <i class="bi bi-info-circle"></i> 
                                                                Hoàn thành mốc @(milestoneNumber - 1) để mở khóa
                                                            </p>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        }
                                    </div>
                                </div>
                            }

                            @if (Model.CampaignDocuments?.Any() == true)
                            {
                                <div class="documents-section mt-5">
                                    <h3 class="section-title">Tài liệu đính kèm</h3>
                                    <div class="documents-list">
                                        @foreach (var doc in Model.CampaignDocuments)
                                        {
                                            @if (doc.FileType?.ToLower() == "image")
                                            {
                                                <div class="document-image-item mb-3">
                                                    <img src="@doc.FileUrl" 
                                                         alt="@(doc.Description ?? "Hình ảnh tài liệu")" 
                                                         class="img-fluid rounded shadow-sm"
                                                         onerror="this.src='@Url.Content("~/Images/DefaultPic.png")'" />
                                                    @if (!string.IsNullOrEmpty(doc.Description))
                                                    {
                                                        <p class="text-muted mt-2 mb-0">
                                                            <i class="bi bi-image me-2"></i>@doc.Description
                                                        </p>
                                                    }
                                                </div>
                                            }
                                            else if (doc.FileType?.ToLower() == "pdf")
                                            {
                                                <a href="@doc.FileUrl" target="_blank" class="document-item">
                                                    <i class="bi bi-file-earmark-pdf me-2 text-danger"></i>
                                                    <span>@(doc.Description ?? "Tài liệu PDF")</span>
                                                    <i class="bi bi-download ms-auto"></i>
                                                </a>
                                            }
                                            else if (doc.FileType?.ToLower() == "doc")
                                            {
                                                <a href="@doc.FileUrl" target="_blank" class="document-item">
                                                    <i class="bi bi-file-earmark-word me-2 text-primary"></i>
                                                    <span>@(doc.Description ?? "Tài liệu Word")</span>
                                                    <i class="bi bi-download ms-auto"></i>
                                                </a>
                                            }
                                            else
                                            {
                                                <a href="@doc.FileUrl" target="_blank" class="document-item">
                                                    <i class="bi bi-file-earmark me-2"></i>
                                                    <span>@(doc.Description ?? "Tài liệu")</span>
                                                    <i class="bi bi-download ms-auto"></i>
                                                </a>
                                            }
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Statistics Tab (Thay thế Updates Tab) -->
                    <div class="tab-pane fade" id="statistics" role="tabpanel">
                        <div class="statistics-content">
                            <h3 class="section-title">Thống kê chiến dịch</h3>
                            
                            <!-- Tổng quan -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-icon bg-primary">
                                            <i class="bi bi-cash-stack"></i>
                                        </div>
                                        <div class="stat-details">
                                            <h4>@String.Format("{0:N0}", current) ₫</h4>
                                            <p class="text-muted mb-0">Đã quyên góp</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-icon bg-success">
                                            <i class="bi bi-people-fill"></i>
                                        </div>
                                        <div class="stat-details">
                                            <h4>@donorCount</h4>
                                            <p class="text-muted mb-0">Nhà quyên góp</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-icon bg-info">
                                            <i class="bi bi-chat-dots-fill"></i>
                                        </div>
                                        <div class="stat-details">
                                            <h4>@Model.Comments?.Count</h4>
                                            <p class="text-muted mb-0">Bình luận</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-card">
                                        <div class="stat-icon bg-warning">
                                            <i class="bi bi-graph-up"></i>
                                        </div>
                                        <div class="stat-details">
                                            <h4>@percent%</h4>
                                            <p class="text-muted mb-0">Đạt được</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Biểu đồ quyên góp theo thời gian -->
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-calendar3 me-2"></i>Quyên góp theo thời gian</h5>
                                    @if (successfulDonationsList.Any())
                                    {
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Ngày</th>
                                                        <th>Số lượt</th>
                                                        <th class="text-end">Tổng tiền</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @{
                                                        var donationsByDate = successfulDonationsList
                                                            .GroupBy(d => d.DonatedAt?.Date)
                                                            .OrderByDescending(g => g.Key)
                                                            .Take(10);
                                                    }
                                                    @foreach (var group in donationsByDate)
                                                    {
                                                        <tr>
                                                            <td>@group.Key?.ToString("dd/MM/yyyy")</td>
                                                            <td><span class="badge bg-primary">@group.Count() lượt</span></td>
                                                            <td class="text-end"><strong>@String.Format("{0:N0}", group.Sum(d => d.Amount)) ₫</strong></td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-muted text-center py-4">Chưa có dữ liệu quyên góp</p>
                                    }
                                </div>
                            </div>

                            <!-- Top nhà quyên góp -->
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-trophy me-2"></i>Top nhà quyên góp</h5>
                                    @{
                                        var topDonors = successfulDonationsList
                                            .GroupBy(d => new { 
                                                d.UserId,
                                                IsAnonymous = d.IsAnonymous == true,
                                                Username = d.IsAnonymous == true ? "Ẩn danh" : (d.User?.Username ?? "Người quyên góp")
                                            })
                                            .Select(g => new {
                                                g.Key.Username,
                                                TotalAmount = g.Sum(d => d.Amount),
                                                Count = g.Count()
                                            })
                                            .OrderByDescending(x => x.TotalAmount)
                                            .Take(5);
                                    }
                                    @if (topDonors.Any())
                                    {
                                        <div class="list-group list-group-flush">
                                            @{
                                                int rank = 1;
                                            }
                                            @foreach (var donor in topDonors)
                                            {
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <span class="badge bg-warning text-dark me-2">#@rank</span>
                                                        <strong>@donor.Username</strong>
                                                        <small class="text-muted ms-2">(@donor.Count lần)</small>
                                                    </div>
                                                    <span class="badge bg-success fs-6">@String.Format("{0:N0}", donor.TotalAmount) ₫</span>
                                                </div>
                                                rank++;
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-muted text-center py-4">Chưa có nhà quyên góp nào</p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Donors Tab -->
                    <div class="tab-pane fade" id="donors" role="tabpanel">
                        <div class="donors-content">
                            @{
                                var groupedDonors = successfulDonationsList
                                    .GroupBy(d => new { 
                                        UserId = d.UserId,
                                        IsAnonymous = d.IsAnonymous == true,
                                        Username = d.IsAnonymous == true ? "Ẩn danh" : (d.User?.Username ?? "Người quyên góp")
                                    })
                                    .Select(g => new {
                                        Username = g.Key.Username,
                                        IsAnonymous = g.Key.IsAnonymous,
                                        TotalAmount = g.Sum(d => d.Amount),
                                        DonationCount = g.Count(),
                                        LastDonationDate = g.Max(d => d.DonatedAt)
                                    })
                                    .OrderByDescending(d => d.TotalAmount)
                                    .ToList();
                            }
                            
                            @if (groupedDonors.Any())
                            {
                                <div class="donors-stats mb-4">
                                    <div class="row text-center">
                                        <div class="col-md-4">
                                            <div class="stat-box">
                                                <h3>@groupedDonors.Count</h3>
                                                <p class="text-muted">Nhà quyên góp</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-box">
                                                <h3>@String.Format("{0:N0}", groupedDonors.Sum(d => d.TotalAmount)) ₫</h3>
                                                <p class="text-muted">Đã quyên góp</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-box">
                                                <h3>@String.Format("{0:N0}", groupedDonors.Average(d => d.TotalAmount)) ₫</h3>
                                                <p class="text-muted">Trung bình</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="donors-list">
                                    @foreach (var donor in groupedDonors)
                                    {
                                        <div class="donor-item">
                                            <div class="donor-avatar">
                                                <i class="bi bi-person-circle"></i>
                                            </div>
                                            <div class="donor-info">
                                                <h6>
                                                    @donor.Username
                                                    @if (donor.DonationCount > 1)
                                                    {
                                                        <span class="badge bg-info text-white ms-2">@donor.DonationCount lần</span>
                                                    }
                                                </h6>
                                                <p class="text-muted mb-0">
                                                    Lần gần nhất: @donor.LastDonationDate?.ToString("dd/MM/yyyy HH:mm")
                                                </p>
                                            </div>
                                            <div class="donor-amount">
                                                <strong>@String.Format("{0:N0}", donor.TotalAmount) ₫</strong>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="empty-state text-center py-5">
                                    <i class="bi bi-people" style="font-size: 3rem; color: #ccc;"></i>
                                    <p class="text-muted mt-3">Chưa có nhà quyên góp nào</p>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Comments Tab -->
                    <div class="tab-pane fade" id="comments" role="tabpanel">
                        <div class="comments-content">
                            <div class="comments-list">
                                @if (Model.Comments?.Any() == true)
                                {
                                    <h5 class="mb-3">Tất cả bình luận (@Model.Comments.Count)</h5>
                                    @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                                    {
                                        <div class="comment-item">
                                            <div class="comment-avatar">
                                                <i class="bi bi-person-circle"></i>
                                            </div>
                                            <div class="comment-body">
                                                <div class="comment-header">
                                                    <h6>@comment.User?.Username</h6>
                                                    <small class="text-muted">@comment.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</small>
                                                </div>
                                                <p>@comment.Content</p>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="empty-state text-center py-5">
                                        <i class="bi bi-chat-dots" style="font-size: 3rem; color: #ccc;"></i>
                                        <p class="text-muted mt-3">Chưa có bình luận nào</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="campaign-sidebar sticky-top">
                <!-- Donation Card -->
                <div class="donation-card">
                    <div class="donation-progress">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="amount-raised">
                                <strong>@String.Format("{0:N0}", current) ₫</strong>
                            </span>
                            <span class="percentage">@percent%</span>
                        </div>
                        <div class="progress campaign-progress-bar mb-2">
                            <div class="progress-bar" style="width:@percent%;"></div>
                        </div>
                        <p class="text-muted mb-0">
                            Mục tiêu: <strong>@String.Format("{0:N0}", target) ₫</strong>
                        </p>
                    </div>

                    <div class="donation-stats">
                        <div class="stat-row">
                            <i class="bi bi-people-fill"></i>
                            <span><strong>@donorCount</strong> nhà quyên góp</span>
                        </div>
                        <div class="stat-row">
                            <i class="bi bi-calendar-check"></i>
                            <span><strong>@(daysLeft > 0 ? daysLeft : 0)</strong> ngày còn lại</span>
                        </div>
                        @if (Model.StartDate.HasValue)
                        {
                            <div class="stat-row">
                                <i class="bi bi-clock-history"></i>
                                <span>Bắt đầu: <strong>@Model.StartDate.Value.ToString("dd/MM/yyyy")</strong></span>
                            </div>
                        }
                    </div>

                    <!-- Thay thế nút Quyên góp và Chia sẻ bằng nút Tạo tin tức -->
                    <div class="donation-actions">
                        <a href="@Url.Action("CreateUpdate", "Campaign", new { id = Model.CampaignId })" class="btn btn-success btn-lg w-100 mb-2">
                            <i class="bi bi-newspaper me-2"></i>Tạo tin tức
                        </a>
                        <a href="@Url.Action("Details", "Campaign", new { id = Model.CampaignId })" class="btn btn-outline-primary w-100" target="_blank">
                            <i class="bi bi-eye me-2"></i>Xem trang công khai
                        </a>
                    </div>
                </div>

                <!-- Campaign Status -->
                <div class="status-card mt-3">
                    <h6 class="card-title">
                        <i class="bi bi-info-circle me-2"></i>Trạng thái
                    </h6>
                    <div class="status-badge status-@(Model.Status?.ToLower() ?? "active")">
                        @switch (Model.Status?.ToLower())
                        {
                            case "active":
                                <i class="bi bi-check-circle-fill me-2"></i>
                                <span>Đang hoạt động</span>
                                break;
                            case "completed":
                                <i class="bi bi-flag-fill me-2"></i>
                                <span>Đã hoàn thành</span>
                                break;
                            case "pending":
                            case "pending_approval":
                                <i class="bi bi-clock-fill me-2"></i>
                                <span>Đang chờ duyệt</span>
                                break;
                            default:
                                <span>@Model.Status</span>
                                break;
                        }
                    </div>
                </div>

                <!-- Creator Card -->
                <div class="creator-card mt-3">
                    <h6 class="card-title">
                        <i class="bi bi-person-badge me-2"></i>Người tạo chiến dịch
                    </h6>
                    <div class="creator-info">
                        <div class="creator-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div>
                            <h6>@Model.Creator?.Username</h6>
                            <p class="text-muted mb-0">@Model.Creator?.Email</p>
                        </div>
                    </div>
                </div>

                <!-- Management Actions -->
                
            </div>
        </div>
    </div>
</div>

<style>
    /* Thêm styles cho stat-card */
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.75rem;
        flex-shrink: 0;
    }

    .stat-icon.bg-primary {
        background: linear-gradient(135deg, #0b63b7 0%, #2b9bd3 100%);
    }

    .stat-icon.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .stat-icon.bg-info {
        background: linear-gradient(135deg, #17a2b8 0%, #00bcd4 100%);
    }

    .stat-icon.bg-warning {
        background: linear-gradient(135deg, #ffc107 0%, #ffeb3b 100%);
    }

    .stat-details h4 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }

    .management-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
</style>
