@model TuThien.Models.Campaign
@{
    ViewData["Title"] = "Chỉnh sửa chiến dịch";
    Layout = "~/Views/Shared/_CampaignLayout.cshtml";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    .edit-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 0;
    }

    .section-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        color: #667eea;
    }

    .form-label {
        font-weight: 600;
        color: #4a5568;
        margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem;
        transition: all 0.3s;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }

    .char-counter {
        font-size: 0.875rem;
        color: #718096;
        margin-top: 0.25rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.75rem 2rem;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        border-radius: 8px;
        padding: 0.75rem 2rem;
        font-weight: 600;
    }

    .alert {
        border-radius: 10px;
        border: none;
        padding: 1rem 1.5rem;
    }

    .comparison-card {
        background: #f7fafc;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .comparison-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: #718096;
        margin-bottom: 0.5rem;
    }

    .comparison-value {
        color: #2d3748;
        font-size: 0.95rem;
    }
</style>

<div class="edit-container">
    <h1 class="mb-4 fw-bold">
        <i class="bi bi-pencil-square me-2"></i>Chỉnh sửa chiến dịch
    </h1>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["InfoMessage"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            @TempData["InfoMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="alert alert-warning mb-4">
        <i class="bi bi-shield-exclamation me-2"></i>
        <strong>Lưu ý:</strong> Sau khi bạn gửi yêu cầu chỉnh sửa, admin sẽ xem xét và phê duyệt. 
        Thay đổi chỉ có hiệu lực sau khi được phê duyệt.
    </div>

    <form asp-action="Edit" method="post" enctype="multipart/form-data" id="editForm">
        @Html.AntiForgeryToken()
        <input type="hidden" name="campaignId" value="@Model.CampaignId" />

        <!-- Thông tin hiện tại -->
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-info-circle"></i>
                <span>Thông tin hiện tại</span>
            </div>

            <div class="comparison-card">
                <div class="comparison-label">Tiêu đề hiện tại</div>
                <div class="comparison-value">@Model.Title</div>
            </div>

            <div class="comparison-card">
                <div class="comparison-label">Mục tiêu hiện tại</div>
                <div class="comparison-value">@Model.TargetAmount.ToString("N0") VNĐ</div>
            </div>

            <div class="comparison-card">
                <div class="comparison-label">Danh mục hiện tại</div>
                <div class="comparison-value">@Model.Category?.Name</div>
            </div>
        </div>

        <!-- Thông tin mới -->
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-pencil-fill"></i>
                <span>Thông tin chỉnh sửa</span>
            </div>

            <div class="mb-3">
                <label class="form-label">
                    Tiêu đề <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control" name="title" value="@Model.Title" 
                       required minlength="10" maxlength="255"
                       oninput="updateCharCounter('title', 255)" />
                <div class="d-flex justify-content-between">
                    <small class="text-muted">Tối thiểu 10 ký tự</small>
                    <small class="char-counter" id="title-counter">0/255</small>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">
                    Mô tả chi tiết <span class="text-danger">*</span>
                </label>
                <textarea class="form-control" name="description" rows="10" 
                          required minlength="50"
                          oninput="updateCharCounter('description', 10000)">@Model.Description</textarea>
                <div class="d-flex justify-content-between">
                    <small class="text-muted">Tối thiểu 50 ký tự</small>
                    <small class="char-counter" id="description-counter">0 ký tự</small>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">
                        Mục tiêu (VNĐ) <span class="text-danger">*</span>
                    </label>
                    <input type="number" class="form-control" name="targetAmount" value="@Model.TargetAmount" 
                           required min="100000" step="1000" />
                    <small class="text-muted">Tối thiểu 100,000 VNĐ</small>
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">
                        Danh mục <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" name="categoryId" required>
                        @foreach (var item in (SelectList)ViewData["CategoryId"])
                        {
                            <option value="@item.Value" selected="@item.Selected">@item.Text</option>
                        }
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Ngày bắt đầu</label>
                    <input type="date" class="form-control" name="startDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")" />
                </div>

                <div class="col-md-6 mb-3">
                    <label class="form-label">Ngày kết thúc</label>
                    <input type="date" class="form-control" name="endDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Ảnh đại diện mới</label>
                <input type="file" class="form-control" name="newThumbnailImage" accept="image/*" />
                <small class="text-muted">Chỉ tải lên nếu muốn thay đổi ảnh hiện tại</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Xử lý tiền dư</label>
                <select class="form-select" name="excessFundOption">
                    <option value="next_case" selected="@(Model.ExcessFundOption == "next_case")">Chuyển cho hoàn cảnh tiếp theo</option>
                    <option value="reserve_fund" selected="@(Model.ExcessFundOption == "reserve_fund")">Chuyển vào quỹ dự phòng</option>
                    <option value="general_fund" selected="@(Model.ExcessFundOption == "general_fund")">Sung vào quỹ chung</option>
                    <option value="extend" selected="@(Model.ExcessFundOption == "extend")">Mở rộng phạm vi giúp đỡ</option>
                </select>
            </div>
        </div>

        <!-- Ghi chú thay đổi -->
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-chat-dots-fill"></i>
                <span>Ghi chú về thay đổi</span>
            </div>

            <div class="mb-3">
                <label class="form-label">
                    Mô tả những thay đổi bạn đã thực hiện <span class="text-danger">*</span>
                </label>
                <textarea class="form-control" name="changeNote" rows="5" 
                          required minlength="20"
                          placeholder="Ví dụ: Cập nhật mục tiêu từ 50 triệu lên 70 triệu để chi phí thêm cho thuốc men..."
                          oninput="updateCharCounter('changeNote', 1000)"></textarea>
                <div class="d-flex justify-content-between">
                    <small class="text-muted">Tối thiểu 20 ký tự. Giúp admin hiểu rõ lý do thay đổi.</small>
                    <small class="char-counter" id="changeNote-counter">0 ký tự</small>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-3 justify-content-end">
            <a asp-action="MyDetails" asp-route-id="@Model.CampaignId" class="btn btn-secondary">
                <i class="bi bi-x-lg me-2"></i>Hủy
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-send-fill me-2"></i>Gửi yêu cầu chỉnh sửa
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        function updateCharCounter(fieldName, maxLength) {
            const input = document.querySelector(`[name="${fieldName}"]`);
            const counter = document.getElementById(`${fieldName}-counter`);
            const length = input.value.length;

            if (fieldName === 'title') {
                counter.textContent = `${length}/${maxLength}`;
            } else {
                counter.textContent = `${length} ký tự`;
            }

            if (length > maxLength * 0.9) {
                counter.classList.add('text-warning');
            } else {
                counter.classList.remove('text-warning');
            }
        }

        // Initialize counters on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCharCounter('title', 255);
            updateCharCounter('description', 10000);
            updateCharCounter('changeNote', 1000);
        });

        // Form validation
        document.getElementById('editForm').addEventListener('submit', function(e) {
            const title = document.querySelector('[name="title"]').value.trim();
            const description = document.querySelector('[name="description"]').value.trim();
            const changeNote = document.querySelector('[name="changeNote"]').value.trim();

            if (title.length < 10) {
                e.preventDefault();
                alert('Tiêu đề phải có ít nhất 10 ký tự');
                return;
            }

            if (description.length < 50) {
                e.preventDefault();
                alert('Mô tả phải có ít nhất 50 ký tự');
                return;
            }

            if (changeNote.length < 20) {
                e.preventDefault();
                alert('Ghi chú thay đổi phải có ít nhất 20 ký tự');
                return;
            }

            // Show loading
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang gửi...';
        });
    </script>
}
