@model TuThien.Models.CampaignCreateViewModel

@{
    ViewData["Title"] = "Tạo chiến dịch mới";
    Layout = "~/Views/Shared/_CampaignLayout.cshtml";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card card-modern border-0">
                <div class="card-body p-4 p-md-5">
                    
                    <div class="text-center mb-5">
                        <h2 class="fw-bold text-primary-custom">
                            <i class="bi bi-heart-pulse-fill me-2"></i>Tạo chiến dịch mới
                        </h2>
                        <p class="text-muted">Hãy chia sẻ câu chuyện và kêu gọi sự giúp đỡ từ cộng đồng</p>
                    </div>

                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger mb-4">
                            @TempData["ErrorMessage"]
                        </div>
                    }

                    <form asp-action="Create" enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4" role="alert"></div>

                        <!-- Basic Info -->
                        <h5 class="text-primary-custom mb-3 border-bottom pb-2">1. Thông tin cơ bản</h5>
                        
                        <div class="mb-4">
                            <label asp-for="Title" class="form-label fw-bold">Tiêu đề chiến dịch <span class="text-danger">*</span></label>
                            <input asp-for="Title" class="form-control form-control-lg" placeholder="VD: Giúp đỡ trẻ em vùng cao..." />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>



                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="CategoryId" class="form-label fw-bold">Danh mục <span class="text-danger">*</span></label>
                                <select asp-for="CategoryId" class="form-select form-select-lg" asp-items="ViewBag.CategoryId">
                                    <option value="">-- Chọn danh mục --</option>
                                </select>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="TargetAmount" class="form-label fw-bold">Số tiền mục tiêu (VNĐ) <span class="text-danger">*</span></label>
                                <div class="input-group input-group-lg">
                                    <input asp-for="TargetAmount" class="form-control" type="number" step="100000" min="100000" />
                                    <span class="input-group-text bg-light fw-bold">₫</span>
                                </div>
                                <span asp-validation-for="TargetAmount" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Description" class="form-label fw-bold">Câu chuyện của bạn <span class="text-danger">*</span></label>
                            <textarea asp-for="Description" class="form-control" rows="8" placeholder="Kể chi tiết về hoàn cảnh, lý do gây quỹ và kế hoạch sử dụng tiền..."></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <!-- Verification Documents Section -->
                        <div class="mb-4 p-4 bg-light rounded-3 border">
                            <h5 class="text-primary-custom mb-3"><i class="bi bi-shield-check me-2"></i>Giấy tờ xác nhận</h5>
                            <p class="text-muted small">Vui lòng tải lên các giấy tờ xác thực (Giấy hộ nghèo, quyết định chính quyền, hình ảnh thực tế...) để tăng độ tin cậy cho chiến dịch.</p>
                            
                            <div id="documentsContainer">
                                <!-- Dynamic rows will be added here -->
                                <div class="row g-2 mb-2 doc-row">
                                    <div class="col-md-5">
                                        <input name="VerificationDocuments" class="form-control" type="file" accept=".pdf,image/*" required />
                                    </div>
                                    <div class="col-md-6">
                                        <input name="VerificationDocDescriptions" class="form-control" placeholder="Mô tả (VD: Giấy chứng nhận hộ nghèo)" required />
                                    </div>
                                    <div class="col-md-1 text-end">
                                        <button type="button" class="btn btn-outline-danger btn-sm remove-doc" disabled>
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="btnAddDocument">
                                <i class="bi bi-plus-circle me-1"></i>Thêm tài liệu khác
                            </button>
                        </div>

                        <!-- Time & Settings -->
                        <h5 class="text-primary-custom mb-3 border-bottom pb-2 mt-5">2. Thời gian & Cài đặt</h5>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label asp-for="StartDate" class="form-label fw-bold">Ngày bắt đầu <span class="text-danger">*</span></label>
                                <input asp-for="StartDate" class="form-control form-control-lg" />
                                <span asp-validation-for="StartDate" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="EndDate" class="form-label fw-bold">Ngày kết thúc <span class="text-danger">*</span></label>
                                <input asp-for="EndDate" class="form-control form-control-lg" />
                                <span asp-validation-for="EndDate" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ExcessFundOption" class="form-label fw-bold">Phương án xử lý quỹ dư thừa</label>
                            <select asp-for="ExcessFundOption" class="form-select">
                                <option value="next_case">Chuyển cho hoàn cảnh tiếp theo</option>
                                <option value="general_fund">Sung vào quỹ chung</option>
                                <option value="extend">Mở rộng phạm vi giúp đỡ</option>
                            </select>
                            <small class="text-muted">Lựa chọn cách xử lý nếu số tiền quyên góp vượt quá mục tiêu.</small>
                        </div>

                        <div class="mb-4 form-check form-switch">
                            <input asp-for="IsPhased" class="form-check-input" type="checkbox" id="chkIsPhased">
                            <label class="form-check-label fw-bold" for="chkIsPhased">Chia thành nhiều giai đoạn (Milestones)</label>
                            <small class="d-block text-muted">Cho phép chia nhỏ mục tiêu và thời gian thành từng giai đoạn cụ thể.</small>
                        </div>

                        <div id="milestonesSection" class="mb-4 p-4 bg-light rounded-3 border @(Model.IsPhased ? "" : "d-none")">
                            <h5 class="text-primary-custom mb-3"><i class="bi bi-flag me-2"></i>Các giai đoạn chiến dịch</h5>
                            <div class="alert alert-info small mb-3">
                                <i class="bi bi-info-circle me-1"></i> Tổng số tiền các giai đoạn phải bằng <strong>số tiền mục tiêu</strong>. Thời gian các giai đoạn phải liên tiếp và kết thúc trước ngày kết thúc chiến dịch.
                            </div>
                            
                            <div id="milestonesContainer">
                                @if (Model.Milestones != null && Model.Milestones.Count > 0)
                                {
                                    for (int i = 0; i < Model.Milestones.Count; i++)
                                    {
                                        <div class="row g-2 mb-2 milestone-row">
                                            <div class="col-md-4">
                                                <label class="small text-muted">Tên giai đoạn</label>
                                                <input name="Milestones[@i].Title" class="form-control" placeholder="Giai đoạn @(i + 1)" required value="@Model.Milestones[i].Title" />
                                                <span class="text-danger small field-validation-valid" data-valmsg-for="Milestones[@i].Title" data-valmsg-replace="true"></span>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="small text-muted">Số tiền</label>
                                                <input name="Milestones[@i].AmountNeeded" class="form-control milestone-amount" type="number" placeholder="Số tiền" required value="@Model.Milestones[i].AmountNeeded" />
                                                <span class="text-danger small field-validation-valid" data-valmsg-for="Milestones[@i].AmountNeeded" data-valmsg-replace="true"></span>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="small text-muted">Kết thúc</label>
                                                <input name="Milestones[@i].Deadline" class="form-control milestone-deadline" type="date" required value="@Model.Milestones[i].Deadline.ToString("yyyy-MM-dd")" />
                                                <span class="text-danger small field-validation-valid" data-valmsg-for="Milestones[@i].Deadline" data-valmsg-replace="true"></span>
                                            </div>
                                            <div class="col-md-1 text-end d-flex align-items-end justify-content-end">
                                                <button type="button" class="btn btn-outline-danger btn-sm remove-milestone">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="btnAddMilestone">
                                <i class="bi bi-plus-circle me-1"></i>Thêm giai đoạn
                            </button>
                            <div class="mt-2 fw-bold text-end text-primary-custom">
                                Tổng tiền: <span id="totalMilestoneAmount">0</span> đ / <span id="displayTargetAmount">0</span> đ
                            </div>
                        </div>

                        <!-- Images -->
                        <h5 class="text-primary-custom mb-3 border-bottom pb-2 mt-5">3. Hình ảnh</h5>

                        <div class="mb-4">
                            <label asp-for="ThumbnailImage" class="form-label fw-bold">Ảnh đại diện chiến dịch</label>
                            <div class="card bg-light border-dashed text-center p-4" onclick="document.getElementById('ThumbnailImage').click()" style="cursor: pointer; border: 2px dashed #dee2e6;">
                                <div class="my-3">
                                    <i class="bi bi-cloud-arrow-up display-4 text-muted"></i>
                                </div>
                                <p class="mb-0 text-muted">Nhấn để tải ảnh lên (JPG, PNG)</p>
                                <div id="imagePreview" class="mt-3 d-none">
                                    <img src="" alt="Preview" class="img-fluid rounded shadow-sm" style="max-height: 200px;">
                                </div>
                            </div>
                            <input asp-for="ThumbnailImage" class="d-none" accept="image/*" onchange="previewImage(this)" />
                            <span asp-validation-for="ThumbnailImage" class="text-danger"></span>
                        </div>

                        <!-- Actions -->
                        <div class="d-grid gap-2 mt-5">
                            <button type="submit" class="btn btn-primary-gradient btn-lg py-3 text-uppercase fw-bold text-white shadow">
                                <i class="bi bi-send-fill me-2"></i>Gửi yêu cầu duyệt
                            </button>
                            <a asp-controller="TrangChu" asp-action="Index" class="btn btn-light btn-lg text-muted">Hủy bỏ</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var preview = document.getElementById('imagePreview');
                    var img = preview.querySelector('img');
                    img.src = e.target.result;
                    preview.classList.remove('d-none');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Dynamic Documents Script
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('documentsContainer');
            const btnAdd = document.getElementById('btnAddDocument');

            btnAdd.addEventListener('click', function() {
                const row = document.createElement('div');
                row.className = 'row g-2 mb-2 doc-row';
                row.innerHTML = `
                    <div class="col-md-5">
                        <input name="VerificationDocuments" class="form-control" type="file" accept=".pdf,image/*" required />
                    </div>
                    <div class="col-md-6">
                        <input name="VerificationDocDescriptions" class="form-control" placeholder="Mô tả..." required />
                    </div>
                    <div class="col-md-1 text-end">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-doc">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(row);
                updateRemoveButtons();
            });

            container.addEventListener('click', function(e) {
                if (e.target.closest('.remove-doc')) {
                    const row = e.target.closest('.doc-row');
                    if (document.querySelectorAll('.doc-row').length > 1) {
                        row.remove();
                        updateRemoveButtons();
                    }
                }
            });

            function updateRemoveButtons() {
                const rows = document.querySelectorAll('.doc-row');
                const buttons = document.querySelectorAll('.remove-doc');
                buttons.forEach(btn => {
                    btn.disabled = rows.length === 1;
                });
            }
        });

        // Campaign Phases Script
        document.addEventListener('DOMContentLoaded', function() {
            const chkIsPhased = document.getElementById('chkIsPhased');
            const milestonesSection = document.getElementById('milestonesSection');
            const milestonesContainer = document.getElementById('milestonesContainer');
            const btnAddMilestone = document.getElementById('btnAddMilestone');
            const targetAmountInput = document.getElementById('TargetAmount');
            const displayTargetSpan = document.getElementById('displayTargetAmount');
            const totalMilestoneSpan = document.getElementById('totalMilestoneAmount');
            
            // Toggle Section
            if(chkIsPhased) {
                // Initialize state on load
                if(chkIsPhased.checked) {
                    milestonesSection.classList.remove('d-none');
                    if(milestonesContainer.children.length === 0) {
                        addMilestoneRow(); // Add first row only if empty
                    } else {
                        calculateTotal(); // Recalculate if existing rows
                    }
                }

                chkIsPhased.addEventListener('change', function() {
                    if(this.checked) {
                        milestonesSection.classList.remove('d-none');
                        if(milestonesContainer.children.length === 0) {
                            addMilestoneRow(); // Add first row if empty
                        }
                    } else {
                        milestonesSection.classList.add('d-none');
                    }
                });
            }

            // Update Target Display
            if(targetAmountInput) {
                targetAmountInput.addEventListener('input', function() {
                    displayTargetSpan.textContent = Number(this.value).toLocaleString('vi-VN');
                });
            }

            // Add Milestone Row
            if(btnAddMilestone) {
                btnAddMilestone.addEventListener('click', addMilestoneRow);
            }

            function addMilestoneRow() {
                const index = milestonesContainer.children.length;
                const row = document.createElement('div');
                row.className = 'row g-2 mb-2 milestone-row';
                row.innerHTML = `
                    <div class="col-md-4">
                        <label class="small text-muted">Tên giai đoạn</label>
                        <input name="Milestones[${index}].Title" class="form-control" placeholder="Giai đoạn ${index + 1}" required />
                    </div>
                    <div class="col-md-3">
                        <label class="small text-muted">Số tiền</label>
                        <input name="Milestones[${index}].AmountNeeded" class="form-control milestone-amount" type="number" placeholder="Số tiền" required />
                    </div>
                    <div class="col-md-4">
                        <label class="small text-muted">Kết thúc</label>
                        <input name="Milestones[${index}].Deadline" class="form-control milestone-deadline" type="date" required />
                    </div>
                    <div class="col-md-1 text-end d-flex align-items-end justify-content-end">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-milestone">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                milestonesContainer.appendChild(row);
                updateMilestoneIndices();
            }

            // Event Delegation for Dynamic Elements
            if(milestonesContainer) {
                milestonesContainer.addEventListener('click', function(e) {
                    if (e.target.closest('.remove-milestone')) {
                        const row = e.target.closest('.milestone-row');
                        row.remove();
                        updateMilestoneIndices();
                        calculateTotal();
                    }
                });

                milestonesContainer.addEventListener('input', function(e) {
                    if(e.target.classList.contains('milestone-amount')) {
                        calculateTotal();
                    }
                });
            }

            function updateMilestoneIndices() {
                const rows = milestonesContainer.querySelectorAll('.milestone-row');
                rows.forEach((row, index) => {
                    row.querySelector('input[name$=".Title"]').name = `Milestones[${index}].Title`;
                    row.querySelector('input[name$=".AmountNeeded"]').name = `Milestones[${index}].AmountNeeded`;
                    row.querySelector('input[name$=".Deadline"]').name = `Milestones[${index}].Deadline`;
                });
                calculateTotal();
            }

            function calculateTotal() {
                let total = 0;
                const inputs = milestonesContainer.querySelectorAll('.milestone-amount');
                inputs.forEach(input => {
                    total += Number(input.value) || 0;
                });
                totalMilestoneSpan.textContent = total.toLocaleString('vi-VN');
                
                // Visual validation
                const target = Number(targetAmountInput.value) || 0;
                if(total !== target) {
                    totalMilestoneSpan.classList.add('text-danger');
                    totalMilestoneSpan.classList.remove('text-success');
                } else {
                    totalMilestoneSpan.classList.remove('text-danger');
                    totalMilestoneSpan.classList.add('text-success');
                }
            }
            
            // Client-side Form Validation
            const form = document.querySelector('form');
            if(form) {
                form.addEventListener('submit', function(e) {
                    if(chkIsPhased && chkIsPhased.checked) {
                        const target = Number(targetAmountInput.value) || 0;
                        let total = 0;
                        const amounts = milestonesContainer.querySelectorAll('.milestone-amount');
                        amounts.forEach(i => total += Number(i.value) || 0);

                        if(total !== target) {
                            e.preventDefault();
                            alert(`Tổng tiền các giai đoạn (${total.toLocaleString()}) phải bằng tiền mục tiêu (${target.toLocaleString()})!`);
                            return;
                        }

                        // Date Validation
                        const deadlines = Array.from(milestonesContainer.querySelectorAll('.milestone-deadline')).map(i => new Date(i.value));
                        const campaignEnd = new Date(document.getElementById('EndDate').value);

                        for(let i = 0; i < deadlines.length; i++) {
                            if(deadlines[i] > campaignEnd) {
                                e.preventDefault();
                                alert(`Giai đoạn ${i+1} kết thúc sau ngày kết thúc chiến dịch!`);
                                return;
                            }
                            if(i > 0 && deadlines[i] < deadlines[i - 1]) {
                                e.preventDefault();
                                alert(`Giai đoạn ${i+1} phải kết thúc sau giai đoạn ${i}!`);
                                return;
                            }
                        }
                    }
                });
            }
        });
    </script>
}
