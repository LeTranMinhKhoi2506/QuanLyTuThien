@using Microsoft.AspNetCore.Http
@model TuThien.Models.Campaign

@{
    ViewData["Title"] = Model.Title;
    Layout = "~/Views/Shared/_CampaignLayout.cshtml";
    
    var thumb = string.IsNullOrEmpty(Model.ThumbnailUrl) ? Url.Content("~/Images/DefaultPic.png") : Model.ThumbnailUrl;
    decimal current = Model.CurrentAmount ?? 0m;
    decimal target = Model.TargetAmount;
    int percent = target > 0 ? (int)System.Math.Min(100, System.Math.Round((current / target) * 100)) : 0;
    
    var daysLeft = Model.EndDate.HasValue ? (Model.EndDate.Value - DateTime.Now).Days : 0;
    // Đếm số người quyên góp duy nhất (unique donors)
    var successfulDonationsList = Model.Donations?.Where(d => d.PaymentStatus == "success" || d.PaymentStatus == "completed").ToList() ?? new List<TuThien.Models.Donation>();
    var donorCount = successfulDonationsList
        .GroupBy(d => new { d.UserId, IsAnonymous = d.IsAnonymous == true })
        .Count();
}

<link rel="stylesheet" href="~/css/CampaignDetails.css" asp-append-version="true" />

<div class="campaign-details-page">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="/Campaign">Chiến dịch</a></li>
            @if (Model.Category != null)
            {
                <li class="breadcrumb-item"><a href="/Campaign?categoryId=@Model.Category.CategoryId">@Model.Category.Name</a></li>
            }
            <li class="breadcrumb-item active" aria-current="page">@Model.Title</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Campaign Header -->
            <div class="campaign-header-section mb-4">
                @if (Model.Category != null)
                {
                    <span class="category-badge">
                        <i class="bi bi-tag-fill me-1"></i>@Model.Category.Name
                    </span>
                }
                <h1 class="campaign-main-title">@Model.Title</h1>
                
                <div class="campaign-meta d-flex align-items-center gap-4 mt-3">
                    <div class="meta-item">
                        <i class="bi bi-person-circle me-2"></i>
                        <span>Bởi <strong>@Model.Creator?.Username</strong></span>
                    </div>
                    <div class="meta-item">
                        <i class="bi bi-calendar-event me-2"></i>
                        <span>@Model.CreatedAt?.ToString("dd/MM/yyyy")</span>
                    </div>
                  
                </div>
            </div>

            <!-- Campaign Image -->
            <div class="campaign-main-image mb-4">
                <img src="@thumb" alt="@Model.Title" class="img-fluid rounded-3 shadow" 
                     onerror="this.src='@Url.Content("~/Images/DefaultPic.png")'" />
            </div>

            <!-- Campaign Tabs -->
            <div class="campaign-tabs mb-4">
                <ul class="nav nav-tabs" id="campaignTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="story-tab" data-bs-toggle="tab" data-bs-target="#story" type="button">
                            <i class="bi bi-book me-2"></i>Câu chuyện
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="updates-tab" data-bs-toggle="tab" data-bs-target="#updates" type="button">
                            <i class="bi bi-megaphone me-2"></i>Cập nhật <span class="badge bg-primary ms-1">@Model.CampaignUpdates?.Count</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="donors-tab" data-bs-toggle="tab" data-bs-target="#donors" type="button">
                            <i class="bi bi-people me-2"></i>Nhà quyên góp <span class="badge bg-primary ms-1">@donorCount</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" type="button">
                            <i class="bi bi-chat-dots me-2"></i>Bình luận <span class="badge bg-primary ms-1">@Model.Comments?.Count</span>
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="campaignTabContent">
                    <!-- Story Tab -->
                    <div class="tab-pane fade show active" id="story" role="tabpanel">
                        <div class="story-content">
                            <h3 class="section-title">Về chiến dịch này</h3>
                            <div class="story-text">
                                @Html.Raw(Model.Description?.Replace("\n", "<br/>"))
                            </div>

                            @if (Model.CampaignMilestones?.Any() == true)
                            {
                                <div class="milestones-section mt-5">
                                    <h3 class="section-title">Mốc quan trọng</h3>
                                    <div class="timeline">
                                        @{
                                            // Sắp xếp theo MilestoneId để đảm bảo thứ tự đúng
                                            var milestones = Model.CampaignMilestones.OrderBy(m => m.MilestoneId).ToList();
                                            
                                            // Tính toán trạng thái của từng mốc theo logic tuần tự
                                            bool allPreviousCompleted = true;
                                            decimal cumulativeAmount = 0; // Tổng tiền tích lũy từ tất cả các mốc trước
                                            
                                            for (int i = 0; i < milestones.Count; i++)
                                            {
                                                var milestone = milestones[i];
                                                var milestoneNumber = i + 1;
                                                
                                                // Tính tổng tiền cần thiết cho mốc này (bao gồm cả các mốc trước)
                                                cumulativeAmount += milestone.AmountNeeded;
                                                
                                                // Kiểm tra điều kiện đạt mốc này - phải đủ tổng tiền tích lũy
                                                bool isReached = current >= cumulativeAmount && allPreviousCompleted;
                                                
                                                // Xác định trạng thái: completed, active, locked
                                                string status = "locked";
                                                if (isReached)
                                                {
                                                    status = "completed";
                                                }
                                                else if (allPreviousCompleted)
                                                {
                                                    status = "active";
                                                }
                                                
                                                // Cập nhật flag cho mốc tiếp theo
                                                if (!isReached)
                                                {
                                                    allPreviousCompleted = false;
                                                }
                                                
                                                <div class="timeline-item @status">
                                                    <div class="timeline-marker">
                                                        @if (status == "completed")
                                                        {
                                                            <i class="bi bi-check-circle-fill"></i>
                                                        }
                                                        else if (status == "active")
                                                        {
                                                            <i class="bi bi-circle-half"></i>
                                                        }
                                                        else
                                                        {
                                                            <i class="bi bi-lock-fill"></i>
                                                        }
                                                    </div>
                                                    <div class="timeline-content">
                                                        <div class="milestone-badge milestone-badge-@status">
                                                            Mốc @milestoneNumber
                                                        </div>
                                                        <h5>@milestone.Title</h5>
                                                        <p class="text-muted mb-2">
                                                            <strong>Mục tiêu: @String.Format("{0:N0}", milestone.AmountNeeded) ₫</strong>
                                                        </p>
                                                        <p class="text-muted mb-2">
                                                            <i class="bi bi-piggy-bank"></i> 
                                                            Tổng cần: <strong>@String.Format("{0:N0}", cumulativeAmount) ₫</strong>
                                                        </p>
                                                        
                                                        @if (milestone.Deadline.HasValue)
                                                        {
                                                            <p class="text-muted mb-2">
                                                                <i class="bi bi-calendar3"></i> 
                                                                Deadline: @milestone.Deadline.Value.ToString("dd/MM/yyyy")
                                                            </p>
                                                        }
                                                     
                                                        @if (status == "completed")
                                                        {
                                                            <span class="badge bg-success mt-2">
                                                                <i class="bi bi-check2"></i> Đã đạt được
                                                            </span>
                                                        }
                                                        else if (status == "active")
                                                        {
                                                            var remaining = cumulativeAmount - current;
                                                            var progressPercent = current > 0 && cumulativeAmount > 0 
                                                                ? (int)((current / cumulativeAmount) * 100) 
                                                                : 0;
                                                            
                                                            <div class="milestone-progress mt-2">
                                                                <div class="progress mb-2" style="height: 8px;">
                                                                    <div class="progress-bar bg-warning" role="progressbar" 
                                                                         style="width: @progressPercent%"></div>
                                                                </div>
                                                                <span class="badge bg-warning text-dark">
                                                                    <i class="bi bi-hourglass-split"></i> Đang quyên góp - Còn @String.Format("{0:N0}", remaining) ₫
                                                                </span>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary mt-2">
                                                                <i class="bi bi-lock"></i> Chưa mở khóa
                                                            </span>
                                                            <p class="text-muted small mt-2 mb-0">
                                                                <i class="bi bi-info-circle"></i> 
                                                                Hoàn thành mốc @(milestoneNumber - 1) để mở khóa
                                                            </p>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        }
                                    </div>
                                </div>
                            }



                            @if (Model.CampaignDocuments?.Any() == true)
                            {
                                <div class="documents-section mt-5">
                                    <h3 class="section-title">Tài liệu đính kèm</h3>
                                    <div class="documents-list">
                                        @foreach (var doc in Model.CampaignDocuments)
                                        {
                                            @if (doc.FileType?.ToLower() == "image")
                                            {
                                                <!-- Hiển thị ảnh trực tiếp -->
                                                <div class="document-image-item mb-3">
                                                    <img src="@doc.FileUrl" 
                                                         alt="@(doc.Description ?? "Hình ảnh tài liệu")" 
                                                         class="img-fluid rounded shadow-sm"
                                                         onerror="this.src='@Url.Content("~/Images/DefaultPic.png")'" />
                                                    @if (!string.IsNullOrEmpty(doc.Description))
                                                    {
                                                        <p class="text-muted mt-2 mb-0">
                                                            <i class="bi bi-image me-2"></i>@doc.Description
                                                        </p>
                                                    }
                                                </div>
                                            }
                                            else if (doc.FileType?.ToLower() == "pdf")
                                            {
                                                <!-- Link tải PDF -->
                                                <a href="@doc.FileUrl" target="_blank" class="document-item">
                                                    <i class="bi bi-file-earmark-pdf me-2 text-danger"></i>
                                                    <span>@(doc.Description ?? "Tài liệu PDF")</span>
                                                    <i class="bi bi-download ms-auto"></i>
                                                </a>
                                            }
                                            else if (doc.FileType?.ToLower() == "doc")
                                            {
                                                <!-- Link tải Word/Doc -->
                                                <a href="@doc.FileUrl" target="_blank" class="document-item">
                                                    <i class="bi bi-file-earmark-word me-2 text-primary"></i>
                                                    <span>@(doc.Description ?? "Tài liệu Word")</span>
                                                    <i class="bi bi-download ms-auto"></i>
                                                </a>
                                            }
                                            else
                                            {
                                                <!-- File khác -->
                                                <a href="@doc.FileUrl" target="_blank" class="document-item">
                                                    <i class="bi bi-file-earmark me-2"></i>
                                                    <span>@(doc.Description ?? "Tài liệu")</span>
                                                    <i class="bi bi-download ms-auto"></i>
                                                </a>
                                            }
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Updates Tab -->
                    <div class="tab-pane fade" id="updates" role="tabpanel">
                        <div class="updates-content">
                            @if (Model.CampaignUpdates?.Any() == true)
                            {
                                @foreach (var update in Model.CampaignUpdates.OrderByDescending(u => u.CreatedAt))
                                {
                                    <a href="@Url.Action("Details", "News", new { id = update.UpdateId })" class="update-item-link">
                                        <div class="update-item">
                                            <div class="update-header">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <h5 class="mb-0">@update.Title</h5>
                                                    <i class="bi bi-arrow-right-circle ms-2"></i>
                                                </div>
                                                <div class="d-flex align-items-center gap-3 mt-2">
                                                    <small class="text-muted">
                                                        <i class="bi bi-clock me-1"></i>
                                                        @update.CreatedAt?.ToString("dd/MM/yyyy HH:mm")
                                                    </small>
                                                    @if (update.Type == "financial_report")
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="bi bi-file-earmark-bar-graph me-1"></i>Báo cáo TC
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-primary">
                                                            <i class="bi bi-newspaper me-1"></i>Tin tức
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                            <div class="update-body">
                                                @{
                                                    var excerpt = update.Content?.Length > 150 
                                                        ? System.Text.RegularExpressions.Regex.Replace(update.Content.Substring(0, 150), "<.*?>", "") + "..." 
                                                        : System.Text.RegularExpressions.Regex.Replace(update.Content ?? "", "<.*?>", "");
                                                }
                                                <p class="text-muted mb-0">@excerpt</p>
                                            </div>
                                        </div>
                                    </a>
                                }
                            }
                            else
                            {
                                <div class="empty-state text-center py-5">
                                    <i class="bi bi-megaphone" style="font-size: 3rem; color: #ccc;"></i>
                                    <p class="text-muted mt-3">Chưa có cập nhật nào</p>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Donors Tab -->
                    <div class="tab-pane fade" id="donors" role="tabpanel">
                        <div class="donors-content">
                            @{
                                // Nhóm donations theo người dùng và cộng tổng số tiền
                                var completedDonations = Model.Donations?.Where(d => d.PaymentStatus == "success" || d.PaymentStatus == "completed").ToList() ?? new List<TuThien.Models.Donation>();
                                
                                var groupedDonors = completedDonations
                                    .GroupBy(d => new { 
                                        UserId = d.UserId,
                                        IsAnonymous = d.IsAnonymous == true,
                                        Username = d.IsAnonymous == true ? "Ẩn danh" : (d.User?.Username ?? "Người quyên góp")
                                    })
                                    .Select(g => new {
                                        Username = g.Key.Username,
                                        IsAnonymous = g.Key.IsAnonymous,
                                        TotalAmount = g.Sum(d => d.Amount),
                                        DonationCount = g.Count(),
                                        LastDonationDate = g.Max(d => d.DonatedAt),
                                        Message = g.OrderByDescending(d => d.DonatedAt)
                                                   .Select(d => d.Message)
                                                   .FirstOrDefault(m => !string.IsNullOrEmpty(m))
                                    })
                                    .OrderByDescending(d => d.TotalAmount)
                                    .ToList();
                            }
                            
                            @if (groupedDonors.Any())
                            {
                                <div class="donors-stats mb-4">
                                    <div class="row text-center">
                                        <div class="col-md-4">
                                            <div class="stat-box">
                                                <h3>@groupedDonors.Count</h3>
                                                <p class="text-muted">Nhà quyên góp</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-box">
                                                <h3>@String.Format("{0:N0}", groupedDonors.Sum(d => d.TotalAmount)) ₫</h3>
                                                <p class="text-muted">Đã quyên góp</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="stat-box">
                                                <h3>@String.Format("{0:N0}", groupedDonors.Average(d => d.TotalAmount)) ₫</h3>
                                                <p class="text-muted">Trung bình</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="donors-list">
                                    @foreach (var donor in groupedDonors)
                                    {
                                        <div class="donor-item">
                                            <div class="donor-avatar">
                                                <i class="bi bi-person-circle"></i>
                                            </div>
                                            <div class="donor-info">
                                                <h6>
                                                    @donor.Username
                                                    @if (donor.DonationCount > 1)
                                                    {
                                                        <span class="badge bg-info text-white ms-2">@donor.DonationCount lần</span>
                                                    }
                                                </h6>
                                                <p class="text-muted mb-0">
                                                    Lần gần nhất: @donor.LastDonationDate?.ToString("dd/MM/yyyy HH:mm")
                                                </p>
                                                @if (!string.IsNullOrEmpty(donor.Message))
                                                {
                                                    <div class="mt-1 small text-dark fst-italic">
                                                        <i class="bi bi-chat-quote me-1 text-muted"></i>"@donor.Message"
                                                    </div>
                                                }
                                            </div>
                                            <div class="donor-amount">
                                                <strong>@String.Format("{0:N0}", donor.TotalAmount) ₫</strong>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="empty-state text-center py-5">
                                    <i class="bi bi-people" style="font-size: 3rem; color: #ccc;"></i>
                                    <p class="text-muted mt-3">Chưa có nhà quyên góp nào</p>
                                    <p class="text-muted">Hãy là người đầu tiên đóng góp!</p>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Comments Tab -->
                    <div class="tab-pane fade" id="comments" role="tabpanel">
                        <div class="comments-content">
                            @if (Context.Session.GetInt32("UserId") != null)
                            {
                                <div class="comment-form mb-4">
                                    <h5>Để lại bình luận</h5>
                                    
                                    @if (TempData["SuccessMessage"] != null)
                                    {
                                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                                            @TempData["SuccessMessage"]
                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    }
                                    
                                    @if (TempData["ErrorMessage"] != null)
                                    {
                                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                            @TempData["ErrorMessage"]
                                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        </div>
                                    }
                                    
                                    <form asp-controller="Campaign" asp-action="AddComment" method="post">
                                        <input type="hidden" name="campaignId" value="@Model.CampaignId" />
                                        @Html.AntiForgeryToken()
                                        <div class="mb-3">
                                            <textarea class="form-control" name="content" rows="3" 
                                                      placeholder="Chia sẻ suy nghĩ của bạn..." 
                                                      required
                                                      maxlength="1000"></textarea>
                                            <small class="text-muted">Tối đa 1000 ký tự</small>
                                        </div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-send me-2"></i>Gửi bình luận
                                        </button>
                                    </form>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info mb-4">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <a href="/Account/Login?returnUrl=/Campaign/Details/@Model.CampaignId" class="alert-link">Đăng nhập</a> để bình luận
                                </div>
                            }

                            <div class="comments-list">
                                @if (Model.Comments?.Any() == true)
                                {
                                    <h5 class="mb-3">Tất cả bình luận (@Model.Comments.Count)</h5>
                                    @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                                    {
                                        <div class="comment-item">
                                            <div class="comment-avatar">
                                                <i class="bi bi-person-circle"></i>
                                            </div>
                                            <div class="comment-body">
                                                <div class="comment-header">
                                                    <h6>@comment.User?.Username</h6>
                                                    <small class="text-muted">@comment.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</small>
                                                </div>
                                                <p>@comment.Content</p>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="empty-state text-center py-5">
                                        <i class="bi bi-chat-dots" style="font-size: 3rem; color: #ccc;"></i>
                                        <p class="text-muted mt-3">Chưa có bình luận nào</p>
                                        <p class="text-muted">Hãy là người đầu tiên bình luận!</p>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="campaign-sidebar sticky-top">
                <!-- Donation Card -->
                <div class="donation-card">
                    <div class="donation-progress">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="amount-raised">
                                <strong>@String.Format("{0:N0}", current) ₫</strong>
                            </span>
                            <span class="percentage">@percent%</span>
                        </div>
                        <div class="progress campaign-progress-bar mb-2">
                            <div class="progress-bar" style="width:@percent%;"></div>
                        </div>
                        <p class="text-muted mb-0">
                            Mục tiêu: <strong>@String.Format("{0:N0}", target) ₫</strong>
                        </p>
                    </div>

                    <div class="donation-stats">
                        <div class="stat-row">
                            <i class="bi bi-people-fill"></i>
                            <span><strong>@donorCount</strong> nhà quyên góp</span>
                        </div>
                        <div class="stat-row">
                            <i class="bi bi-calendar-check"></i>
                            <span><strong>@(daysLeft > 0 ? daysLeft : 0)</strong> ngày còn lại</span>
                        </div>
                        @if (Model.StartDate.HasValue)
                        {
                            <div class="stat-row">
                                <i class="bi bi-clock-history"></i>
                                <span>Bắt đầu: <strong>@Model.StartDate.Value.ToString("dd/MM/yyyy")</strong></span>
                            </div>
                        }
                    </div>

                    <div class="donation-actions">
                        <a href="/donate/@Model.CampaignId" class="btn btn-primary btn-lg w-100 mb-2">
                            <i class="bi bi-heart-fill me-2"></i>Quyên góp ngay
                        </a>
                        <button class="btn btn-outline-primary w-100">
                            <i class="bi bi-share me-2"></i>Chia sẻ chiến dịch
                        </button>
                    </div>
                </div>

                <!-- Campaign Status -->
                <div class="status-card mt-3">
                    <h6 class="card-title">
                        <i class="bi bi-info-circle me-2"></i>Trạng thái
                    </h6>
                    <div class="status-badge status-@(Model.Status?.ToLower() ?? "active")">
                        @switch (Model.Status?.ToLower())
                        {
                            case "active":
                                <i class="bi bi-check-circle-fill me-2"></i>
                                <span>Đang hoạt động</span>
                                break;
                            case "completed":
                                <i class="bi bi-flag-fill me-2"></i>
                                <span>Đã hoàn thành</span>
                                break;
                            case "pending":
                            case "pending_approval":
                                <i class="bi bi-clock-fill me-2"></i>
                                <span>Đang chờ duyệt</span>
                                break;
                            default:
                                <span>@Model.Status</span>
                                break;
                        }
                    </div>
                </div>

                <!-- Creator Card -->
                <div class="creator-card mt-3">
                    <h6 class="card-title">
                        <i class="bi bi-person-badge me-2"></i>Người tạo chiến dịch
                    </h6>
                    <div class="creator-info">
                        <div class="creator-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div>
                            <h6>@Model.Creator?.Username</h6>
                            <p class="text-muted mb-0">@Model.Creator?.Email</p>
                        </div>
                    </div>
                </div>

                <!-- Share Card -->
                <div class="share-card mt-3">
                    <h6 class="card-title">
                        <i class="bi bi-share me-2"></i>Chia sẻ
                    </h6>
                    <div class="share-buttons">
                        <a href="#" class="share-btn facebook">
                            <i class="bi bi-facebook"></i>
                        </a>
                        <a href="#" class="share-btn twitter">
                            <i class="bi bi-twitter"></i>
                        </a>
                        <a href="#" class="share-btn linkedin">
                            <i class="bi bi-linkedin"></i>
                        </a>
                        <a href="#" class="share-btn copy">
                            <i class="bi bi-link-45deg"></i>
                        </a>
                    </div>
                </div>

                <!-- Report Card -->
                <div class="report-card mt-3">
                    <h6 class="card-title">
                        <i class="bi bi-flag me-2"></i>Báo cáo sai phạm
                    </h6>
                    <p class="text-muted small mb-2">Nếu bạn phát hiện chiến dịch có dấu hiệu vi phạm, hãy báo cáo để Admin xem xét.</p>
                    @if (Context.Session.GetInt32("UserId") != null)
                    {
                        <button type="button" class="btn btn-outline-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#reportModal">
                            <i class="bi bi-exclamation-triangle me-2"></i>Báo cáo chiến dịch
                        </button>
                    }
                    else
                    {
                        <a href="/Account/Login?returnUrl=/Campaign/Details/@Model.CampaignId" class="btn btn-outline-secondary btn-sm w-100">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Đăng nhập để báo cáo
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
@if (Context.Session.GetInt32("UserId") != null)
{
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="reportModalLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i>Báo cáo chiến dịch
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Bạn đang báo cáo chiến dịch: <strong>@Model.Title</strong>
                    </div>
                    <form id="reportForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="campaignId" value="@Model.CampaignId" />
                        <div class="mb-3">
                            <label for="reportReason" class="form-label fw-bold">Lý do báo cáo <span class="text-danger">*</span></label>
                            <select class="form-select mb-2" id="reportReasonSelect" onchange="updateReportReason()">
                                <option value="">-- Chọn lý do --</option>
                                <option value="Thông tin sai sự thật">Thông tin sai sự thật</option>
                                <option value="Lừa đảo, gian lận">Lừa đảo, gian lận</option>
                                <option value="Sử dụng tiền sai mục đích">Sử dụng tiền sai mục đích</option>
                                <option value="Nội dung không phù hợp">Nội dung không phù hợp</option>
                                <option value="Vi phạm quyền riêng tư">Vi phạm quyền riêng tư</option>
                                <option value="other">Lý do khác...</option>
                            </select>
                            <textarea class="form-control" id="reportReason" name="reason" rows="4" 
                                      placeholder="Mô tả chi tiết lý do báo cáo của bạn..." 
                                      required maxlength="1000"></textarea>
                            <small class="text-muted">Tối đa 1000 ký tự</small>
                        </div>
                    </form>
                    <div id="reportResult" class="d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i>Hủy
                    </button>
                    <button type="button" class="btn btn-danger" id="submitReportBtn" onclick="submitReport()">
                        <i class="bi bi-send me-1"></i>Gửi báo cáo
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Move the modal to the body to ensure it appears above all other elements (z-index fix)
        document.addEventListener('DOMContentLoaded', function() {
            var reportModal = document.getElementById('reportModal');
            if (reportModal) {
                document.body.appendChild(reportModal);
            }
        });

        function updateReportReason() {
            var select = document.getElementById('reportReasonSelect');
            var textarea = document.getElementById('reportReason');
            
            if (select.value && select.value !== 'other') {
                textarea.value = select.value;
            } else if (select.value === 'other') {
                textarea.value = '';
                textarea.focus();
            }
        }

        function submitReport() {
            var form = document.getElementById('reportForm');
            var reason = document.getElementById('reportReason').value.trim();
            var submitBtn = document.getElementById('submitReportBtn');
            var resultDiv = document.getElementById('reportResult');
            
            if (!reason) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = '<i class="bi bi-exclamation-circle me-2"></i>Vui lòng nhập lý do báo cáo.';
                resultDiv.classList.remove('d-none');
                return;
            }

            // Disable button và hiển thị loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang gửi...';

            var formData = new FormData(form);

            fetch('@Url.Action("ReportCampaign", "Campaign")', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                resultDiv.classList.remove('d-none');
                if (data.success) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = '<i class="bi bi-check-circle me-2"></i>' + data.message;
                    // Ẩn form và nút submit
                    document.getElementById('reportForm').classList.add('d-none');
                    submitBtn.classList.add('d-none');
                    // Đổi nút Hủy thành Đóng
                    var cancelBtn = document.querySelector('#reportModal .btn-secondary');
                    if(cancelBtn) cancelBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Đóng';
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = '<i class="bi bi-exclamation-circle me-2"></i>' + data.message;
                    // Enable lại button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-send me-1"></i>Gửi báo cáo';
                }
            })
            .catch(error => {
                resultDiv.classList.remove('d-none');
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = '<i class="bi bi-exclamation-circle me-2"></i>Có lỗi xảy ra. Vui lòng thử lại.';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-send me-1"></i>Gửi báo cáo';
            });
        }

        // Reset modal khi đóng
        document.getElementById('reportModal')?.addEventListener('hidden.bs.modal', function () {
            document.getElementById('reportForm').classList.remove('d-none');
            document.getElementById('reportForm').reset();
            document.getElementById('reportResult').classList.add('d-none');
            var submitBtn = document.getElementById('submitReportBtn');
            submitBtn.classList.remove('d-none');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-send me-1"></i>Gửi báo cáo';
            document.querySelector('#reportModal .btn-secondary').innerHTML = '<i class="bi bi-x-lg me-1"></i>Hủy';
        });
    </script>
}
