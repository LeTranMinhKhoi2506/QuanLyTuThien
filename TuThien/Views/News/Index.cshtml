@model IEnumerable<TuThien.Models.CampaignUpdate>

@{
    ViewData["Title"] = "Tin tức & Cập nhật";
    Layout = "~/Views/Shared/MainLayout.cshtml";
    
    var type = ViewBag.Type as string;
    var search = ViewBag.Search as string;
    var campaignId = ViewBag.CampaignId as int?;
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    var totalUpdates = ViewBag.TotalUpdates ?? 0;
    var generalCount = ViewBag.GeneralCount ?? 0;
    var financialCount = ViewBag.FinancialCount ?? 0;
    var campaigns = ViewBag.Campaigns as IEnumerable<dynamic>;
}

<link rel="stylesheet" href="~/css/News.css" asp-append-version="true" />

<div class="news-page">
    <!-- Page Header -->
    <div class="page-header mb-5">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="page-title">
                    <i class="bi bi-newspaper me-3"></i>Tin tức & Cập nhật
                </h1>
                <p class="page-subtitle">
                    Theo dõi các hoạt động và cập nhật mới nhất từ các chiến dịch từ thiện
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="stats-summary">
                    <div class="stat-item">
                        <strong>@totalUpdates</strong>
                        <span>Tin tức</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section mb-4">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <form method="get" asp-action="Index" class="row g-3">
                    <!-- Search -->
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-white">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" name="search" class="form-control" 
                                   placeholder="Tìm kiếm tin tức..." value="@search" />
                        </div>
                    </div>

                    <!-- Type Filter -->
                    <div class="col-md-3">
                        <select name="type" class="form-select">
                            <option value="">Tất cả loại tin</option>
                            <option value="general" selected="@(type == "general")">
                                Tin tức chung (@generalCount)
                            </option>
                            <option value="financial_report" selected="@(type == "financial_report")">
                                Báo cáo tài chính (@financialCount)
                            </option>
                        </select>
                    </div>

                    <!-- Campaign Filter -->
                    <div class="col-md-3">
                        <select name="campaignId" class="form-select">
                            <option value="">Tất cả chiến dịch</option>
                            @if (campaigns != null)
                            {
                                @foreach (var campaign in campaigns)
                                {
                                    <option value="@campaign.CampaignId" 
                                            selected="@(campaignId == campaign.CampaignId)">
                                        @campaign.Title
                                    </option>
                                }
                            }
                        </select>
                    </div>

                    <!-- Submit Button -->
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-funnel me-2"></i>Lọc
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Filter Tabs -->
    <div class="quick-filters mb-4">
        <a href="@Url.Action("Index")" class="filter-tab @(string.IsNullOrEmpty(type) ? "active" : "")">
            <i class="bi bi-collection me-2"></i>Tất cả
        </a>
        <a href="@Url.Action("Index", new { type = "general" })" 
           class="filter-tab @(type == "general" ? "active" : "")">
            <i class="bi bi-newspaper me-2"></i>Tin tức chung
        </a>
        <a href="@Url.Action("Index", new { type = "financial_report" })" 
           class="filter-tab @(type == "financial_report" ? "active" : "")">
            <i class="bi bi-bar-chart-line me-2"></i>Báo cáo tài chính
        </a>
        <a href="@Url.Action("Latest")" class="filter-tab">
            <i class="bi bi-clock-history me-2"></i>Mới nhất
        </a>
    </div>

    <!-- News Grid -->
    @if (Model != null && Model.Any())
    {
        <div class="row g-4 news-grid">
            @foreach (var update in Model)
            {
                var firstImage = "";
                try
                {
                    if (!string.IsNullOrEmpty(update.ImageUrls))
                    {
                        var images = System.Text.Json.JsonSerializer.Deserialize<List<string>>(update.ImageUrls);
                        firstImage = images?.FirstOrDefault() ?? "";
                    }
                }
                catch { }

                var campaignThumb = string.IsNullOrEmpty(firstImage) 
                    ? (update.Campaign?.ThumbnailUrl ?? Url.Content("~/Images/DefaultPic.png"))
                    : firstImage;

                var excerpt = update.Content?.Length > 150 
                    ? System.Text.RegularExpressions.Regex.Replace(update.Content.Substring(0, 150), "<.*?>", "") + "..." 
                    : System.Text.RegularExpressions.Regex.Replace(update.Content ?? "", "<.*?>", "");

                <div class="col-lg-4 col-md-6">
                    <article class="news-card" onclick="location.href='@Url.Action("Details", new { id = update.UpdateId })'">
                        <div class="news-image-wrapper">
                            <img src="@campaignThumb" alt="@update.Title" class="news-image"
                                 onerror="this.src='@Url.Content("~/Images/DefaultPic.png")'" />
                            
                            <div class="news-badge">
                                @if (update.Type == "financial_report")
                                {
                                    <span class="badge badge-financial">
                                        <i class="bi bi-file-earmark-bar-graph me-1"></i>Báo cáo TC
                                    </span>
                                }
                                else
                                {
                                    <span class="badge badge-general">
                                        <i class="bi bi-newspaper me-1"></i>Tin tức
                                    </span>
                                }
                            </div>
                        </div>

                        <div class="news-content">
                            <!-- Campaign Tag -->
                            @if (update.Campaign != null)
                            {
                                <a href="@Url.Action("Details", "TrangChu", new { id = update.Campaign.CampaignId })" 
                                   class="campaign-tag" onclick="event.stopPropagation()">
                                    <i class="bi bi-tag-fill me-1"></i>
                                    @(update.Campaign.Category?.Name ?? "Chiến dịch")
                                </a>
                            }

                            <h3 class="news-title">
                                @update.Title
                            </h3>

                            <p class="news-excerpt">
                                @excerpt
                            </p>

                            <div class="news-meta">
                                <div class="meta-item">
                                    <i class="bi bi-person-circle me-1"></i>
                                    <span>@(update.Author?.Username ?? "Admin")</span>
                                </div>
                                <div class="meta-item">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    <span>@update.CreatedAt?.ToString("dd/MM/yyyy")</span>
                                </div>
                            </div>

                            <div class="news-campaign-link">
                                <i class="bi bi-arrow-right-circle me-2"></i>
                                <span>@update.Campaign?.Title</span>
                            </div>
                        </div>
                    </article>
                </div>
            }
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <nav aria-label="Page navigation" class="mt-5">
                <ul class="pagination justify-content-center">
                    <!-- Previous -->
                    <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                        <a class="page-link" 
                           href="@Url.Action("Index", new { type, search, campaignId, page = currentPage - 1 })">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>

                    <!-- Page Numbers -->
                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        <li class="page-item @(i == currentPage ? "active" : "")">
                            <a class="page-link" 
                               href="@Url.Action("Index", new { type, search, campaignId, page = i })">
                                @i
                            </a>
                        </li>
                    }

                    <!-- Next -->
                    <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                        <a class="page-link" 
                           href="@Url.Action("Index", new { type, search, campaignId, page = currentPage + 1 })">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        }
    }
    else
    {
        <!-- Empty State -->
        <div class="empty-state text-center py-5">
            <div class="empty-icon mb-4">
                <i class="bi bi-inbox" style="font-size: 5rem; color: #dee2e6;"></i>
            </div>
            <h4 class="text-muted">Không tìm thấy tin tức nào</h4>
            <p class="text-muted">Thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
            <a href="@Url.Action("Index")" class="btn btn-primary mt-3">
                <i class="bi bi-arrow-clockwise me-2"></i>Xem tất cả tin tức
            </a>
        </div>
    }
</div>

@section Scripts {
    <script src="~/js/news.js" asp-append-version="true"></script>
}
