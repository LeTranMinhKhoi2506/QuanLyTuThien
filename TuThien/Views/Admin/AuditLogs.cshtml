@model List<TuThien.Models.AuditLog>
@{
    ViewData["Title"] = "Nhật ký hệ thống";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    
    // Helper function to format action names
    string FormatActionName(string action) => action switch
    {
        "APPROVE_CAMPAIGN" => "Phê duyệt chiến dịch",
        "REJECT_CAMPAIGN" => "Từ chối chiến dịch",
        "CLOSE_CAMPAIGN" => "Đóng chiến dịch",
        "ADMIN_CREATE_CAMPAIGN" => "Tạo chiến dịch",
        "ADMIN_UPDATE_CAMPAIGN" => "Cập nhật chiến dịch",
        "ADMIN_DELETE_CAMPAIGN" => "Xóa chiến dịch",
        "ADMIN_CREATE_USER" => "Tạo người dùng",
        "ADMIN_UPDATE_USER" => "Cập nhật người dùng",
        "ADMIN_DELETE_USER" => "Xóa người dùng",
        "APPROVE_DISBURSEMENT" => "Phê duyệt giải ngân",
        "REJECT_DISBURSEMENT" => "Từ chối giải ngân",
        "EXPORT_DONATIONS" => "Xuất báo cáo quyên góp",
        "TEST_AUDIT" => "Test hệ thống",
        _ => action.Replace("_", " ")
    };
    
    // Helper function to format value for display
    string FormatValue(string? jsonValue)
    {
        if (string.IsNullOrEmpty(jsonValue)) return "N/A";
        
        try
        {
            // Parse JSON and extract meaningful value
            if (jsonValue.Contains("\"value\":"))
            {
                var match = System.Text.RegularExpressions.Regex.Match(jsonValue, "\"value\"\\s*:\\s*\"?([^\"\\}]+)\"?");
                if (match.Success)
                {
                    var val = match.Groups[1].Value.Trim();
                    // Format status values
                    return val switch
                    {
                        "pending_approval" => "Chờ phê duyệt",
                        "active" => "Đang hoạt động",
                        "rejected" => "Đã từ chối",
                        "completed" => "Hoàn thành",
                        "paused" => "Tạm dừng",
                        "locked" => "Đã khóa",
                        "draft" => "Nháp",
                        "pending" => "Đang chờ",
                        "approved" => "Đã duyệt",
                        _ => val
                    };
                }
            }
            return jsonValue;
        }
        catch
        {
            return jsonValue;
        }
    }
}

<div class="alert alert-info mb-4">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Nhật ký hệ thống (Audit Logs)</strong> ghi lại tất cả các hành động quan trọng trong hệ thống để đảm bảo minh bạch và chống gian lận nội bộ.
    <span class="float-end">Tổng: <strong>@(ViewBag.TotalItems ?? 0)</strong> bản ghi</span>
</div>

<!-- Filter Form -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-funnel me-2"></i>Bộ lọc
    </div>
    <div class="card-body">
        <form method="get" asp-action="Index" asp-controller="AdminAudit" class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Hành động</label>
                <select name="actionFilter" class="form-select form-select-sm">
                    <option value="">-- Tất cả --</option>
                    @if (ViewBag.Actions != null)
                    {
                        foreach (var act in (List<string>)ViewBag.Actions)
                        {
                            var isSelected = ViewBag.ActionFilter == act;
                            <option value="@act" selected="@isSelected">@FormatActionName(act)</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Bảng dữ liệu</label>
                <select name="tableName" class="form-select form-select-sm">
                    <option value="">-- Tất cả --</option>
                    @if (ViewBag.Tables != null)
                    {
                        foreach (var table in (List<string>)ViewBag.Tables)
                        {
                            var isSelected = ViewBag.TableName == table;
                            <option value="@table" selected="@isSelected">@table</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">User ID</label>
                <input type="number" name="userId" class="form-control form-control-sm" 
                       value="@ViewBag.UserId" placeholder="ID người dùng" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Từ ngày</label>
                <input type="date" name="fromDate" class="form-control form-control-sm" 
                       value="@(((DateTime?)ViewBag.FromDate)?.ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Đến ngày</label>
                <input type="date" name="toDate" class="form-control form-control-sm" 
                       value="@(((DateTime?)ViewBag.ToDate)?.ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-2 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-search me-1"></i>Lọc
                </button>
                <a href="@Url.Action("Index", "AdminAudit")" class="btn btn-outline-secondary btn-sm" title="Xóa bộ lọc">
                    <i class="bi bi-x-lg"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-journal-text me-2"></i>Nhật ký hệ thống</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="btnTestAudit">
            <i class="bi bi-bug me-1"></i>Test Audit Log
        </button>
    </div>
    <div class="card-body">
        <table id="auditLogsTable" class="table table-hover table-striped align-middle w-100">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Thời gian</th>
                    <th>Người thực hiện</th>
                    <th>Hành động</th>
                    <th>Bảng</th>
                    <th>Record ID</th>
                    <th>Giá trị cũ</th>
                    <th>Giá trị mới</th>
                    <th>IP</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var log in Model)
                {
                    var actionBadge = log.Action switch
                    {
                        var a when a.Contains("APPROVE") => "bg-success",
                        var a when a.Contains("REJECT") || a.Contains("DELETE") => "bg-danger",
                        var a when a.Contains("UPDATE") => "bg-warning text-dark",
                        var a when a.Contains("CREATE") => "bg-info",
                        var a when a.Contains("EXPORT") => "bg-primary",
                        var a when a.Contains("TEST") => "bg-secondary",
                        _ => "bg-dark"
                    };
                    
                    var oldValueFormatted = FormatValue(log.OldValue);
                    var newValueFormatted = FormatValue(log.NewValue);
                    
                    <tr>
                        <td><code>@log.LogId</code></td>
                        <td data-order="@log.CreatedAt?.ToString("yyyy-MM-dd HH:mm:ss")">
                            <small>@log.CreatedAt?.ToString("dd/MM/yyyy")</small><br/>
                            <small class="text-muted">@log.CreatedAt?.ToString("HH:mm:ss")</small>
                        </td>
                        <td>
                            @if (log.User != null)
                            {
                                <span class="badge bg-primary">@log.User.Username</span>
                            }
                            else
                            {
                                <span class="text-muted">System</span>
                            }
                        </td>
                        <td>
                            <span class="badge @actionBadge" title="@log.Action">
                                @FormatActionName(log.Action)
                            </span>
                        </td>
                        <td><code class="text-primary">@log.TableName</code></td>
                        <td><code>@log.RecordId</code></td>
                        <td>
                            @if (!string.IsNullOrEmpty(log.OldValue))
                            {
                                <span class="badge bg-light text-danger border" title="@log.OldValue">
                                    @oldValueFormatted
                                </span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(log.NewValue))
                            {
                                <span class="badge bg-light text-success border" title="@log.NewValue">
                                    @newValueFormatted
                                </span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td><small class="text-muted">@log.IpAddress</small></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
@Html.AntiForgeryToken()
<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#auditLogsTable').DataTable({
        order: [[0, 'desc']], // Sort by ID descending
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tất cả"]],
        language: {
            search: "Tìm kiếm:",
            lengthMenu: "Hiển thị _MENU_ bản ghi",
            info: "Hiển thị _START_ đến _END_ trong tổng số _TOTAL_ bản ghi",
            infoEmpty: "Không có bản ghi nào",
            infoFiltered: "(lọc từ _MAX_ bản ghi)",
            paginate: {
                first: "Đầu",
                last: "Cuối",
                next: "Sau",
                previous: "Trước"
            },
            zeroRecords: "Không tìm thấy bản ghi phù hợp",
            emptyTable: "Không có dữ liệu trong bảng"
        },
        columnDefs: [
            { orderable: false, targets: [6, 7] } // Disable sorting on Old/New value columns
        ],
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip'
    });
    
    // Test Audit Log button
    document.getElementById('btnTestAudit').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang test...';
        
        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            const response = await fetch('@Url.Action("TestLog", "AdminAudit")', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': token
                }
            });
            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert('Lỗi: ' + result.message);
            }
        } catch (error) {
            alert('Lỗi kết nối: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-bug me-1"></i>Test Audit Log';
        }
    });
});
</script>
}
