@model List<TuThien.Models.Campaign>
@{
    ViewData["Title"] = "Quản lý chiến dịch";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Tìm kiếm</label>
                <input type="text" name="search" class="form-control" placeholder="Tên chiến dịch hoặc người tạo..." value="@ViewBag.Search" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Trạng thái</label>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="@Url.Action("Campaigns", "Admin", new { search = ViewBag.Search })" class="btn @(string.IsNullOrEmpty(ViewBag.Status) ? "btn-primary" : "btn-outline-primary") btn-sm">
                        Tất cả
                    </a>
                    <a href="@Url.Action("Campaigns", "Admin", new { status = "pending_approval", search = ViewBag.Search })" class="btn @(ViewBag.Status == "pending_approval" ? "btn-warning" : "btn-outline-warning") btn-sm">
                        Chờ duyệt
                        @if (ViewBag.PendingCount > 0)
                        {
                            <span class="badge bg-dark ms-1">@ViewBag.PendingCount</span>
                        }
                    </a>
                    <a href="@Url.Action("Campaigns", "Admin", new { status = "active", search = ViewBag.Search })" class="btn @(ViewBag.Status == "active" ? "btn-success" : "btn-outline-success") btn-sm">
                        Đang hoạt động
                    </a>
                    <a href="@Url.Action("Campaigns", "Admin", new { status = "draft", search = ViewBag.Search })" class="btn @(ViewBag.Status == "draft" ? "btn-secondary" : "btn-outline-secondary") btn-sm">
                        Nháp
                    </a>
                    <a href="@Url.Action("Campaigns", "Admin", new { status = "completed", search = ViewBag.Search })" class="btn @(ViewBag.Status == "completed" ? "btn-dark" : "btn-outline-dark") btn-sm">
                        Đã hoàn thành
                    </a>
                    <a href="@Url.Action("Campaigns", "Admin", new { status = "rejected", search = ViewBag.Search })" class="btn @(ViewBag.Status == "rejected" ? "btn-danger" : "btn-outline-danger") btn-sm">
                        Từ chối
                    </a>
                </div>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search me-1"></i>Tìm
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card">
<div class="card-header d-flex justify-content-between align-items-center">
    <span><i class="bi bi-megaphone me-2"></i>Danh sách chiến dịch</span>
    <button type="button" class="btn btn-success btn-sm" onclick="showCreateCampaignModal()">
        <i class="bi bi-plus-lg me-1"></i>Thêm chiến dịch
    </button>
</div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Chiến dịch</th>
                        <th>Người tạo</th>
                        <th>Danh mục</th>
                        <th class="text-end">Mục tiêu</th>
                        <th class="text-end">Đã nhận</th>
                        <th>Trạng thái</th>
                        <th>Ngày tạo</th>
                        <th class="text-center">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Count == 0)
                    {
                        <tr>
                            <td colspan="9" class="text-center py-4 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                Không có chiến dịch nào
                            </td>
                        </tr>
                    }
                    @foreach (var campaign in Model)
                    {
                        <tr>
                            <td><code>@campaign.CampaignId</code></td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    @if (!string.IsNullOrEmpty(campaign.ThumbnailUrl))
                                    {
                                        <img src="@campaign.ThumbnailUrl" alt="" class="rounded" style="width: 50px; height: 50px; object-fit: cover;" />
                                    }
                                    else
                                    {
                                        <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                            <i class="bi bi-image text-white"></i>
                                        </div>
                                    }
                                    <div>
                                        <a href="@Url.Action("CampaignDetail", "Admin", new { id = campaign.CampaignId })" class="text-decoration-none fw-semibold">
                                            @campaign.Title
                                        </a>
                                    </div>
                                </div>
                            </td>
                            <td>@campaign.Creator?.Username</td>
                            <td><span class="badge bg-light text-dark">@(campaign.Category?.Name ?? "-")</span></td>
                            <td class="text-end">@campaign.TargetAmount.ToString("N0")đ</td>
                            <td class="text-end">
                                @{
                                    var progress = campaign.TargetAmount > 0 ? (campaign.CurrentAmount ?? 0) / campaign.TargetAmount * 100 : 0;
                                }
                                <div class="fw-semibold text-success">@((campaign.CurrentAmount ?? 0).ToString("N0"))đ</div>
                                <div class="progress" style="height: 4px; width: 60px; margin-left: auto;">
                                    <div class="progress-bar bg-success" style="width: @progress%"></div>
                                </div>
                            </td>
                            <td>
                                @{
                                    var statusBadge = campaign.Status switch
                                    {
                                        "pending_approval" => "badge-pending",
                                        "active" => "badge-active",
                                        "rejected" => "badge-rejected",
                                        "completed" => "bg-secondary",
                                        "paused" => "bg-warning text-dark",
                                        "locked" => "bg-danger",
                                        "draft" => "badge-draft",
                                        _ => "bg-dark"
                                    };
                                    var statusText = campaign.Status switch
                                    {
                                        "pending_approval" => "Chờ duyệt",
                                        "active" => "Hoạt động",
                                        "rejected" => "Từ chối",
                                        "completed" => "Đã hoàn thành",
                                        "paused" => "Tạm dừng",
                                        "locked" => "Bị khóa",
                                        "draft" => "Nháp",
                                        _ => campaign.Status
                                    };
                                }
                                <span class="badge @statusBadge">@statusText</span>
                            </td>
                            <td>
                                <small>@campaign.CreatedAt?.ToString("dd/MM/yyyy")</small>
                            </td>
                            <td class="text-center">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        Hành động
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            <a class="dropdown-item" href="@Url.Action("CampaignDetail", "Admin", new { id = campaign.CampaignId })">
                                                <i class="bi bi-eye me-2"></i>Xem chi tiết
                                            </a>
                                        </li>
                                        @if (campaign.Status == "pending_approval")
                                        {
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button class="dropdown-item text-success" onclick="approveCampaign(@campaign.CampaignId)">
                                                    <i class="bi bi-check-circle me-2"></i>Phê duyệt
                                                </button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item text-danger" onclick="rejectCampaign(@campaign.CampaignId)">
                                                    <i class="bi bi-x-circle me-2"></i>Từ chối
                                                </button>
                                            </li>
                                        }
                                        @if (campaign.Status == "active")
                                        {
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button class="dropdown-item text-warning" onclick="closeCampaign(@campaign.CampaignId)">
                                                    <i class="bi bi-check2-circle me-2"></i>Hoàn thành chiến dịch
                                                </button>
                                            </li>
                                        }
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button class="dropdown-item text-primary" onclick="editCampaign(@campaign.CampaignId)">
                                                <i class="bi bi-pencil me-2"></i>Sửa chiến dịch
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item text-danger" onclick="deleteCampaign(@campaign.CampaignId, '@campaign.Title.Replace("'", "\\'")' )">
                                                <i class="bi bi-trash me-2"></i>Xóa chiến dịch
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    
    @if (ViewBag.TotalPages > 1)
    {
        <div class="card-footer">
            <nav>
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link" href="?page=@i&status=@ViewBag.Status&search=@ViewBag.Search">@i</a>
                        </li>
                    }
                </ul>
            </nav>
        </div>
    }
</div>

@section Scripts {
<!-- Modal Tạo/Sửa Chiến dịch -->
<div class="modal fade" id="campaignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="campaignModalTitle">Thêm chiến dịch mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="campaignForm">
                    <input type="hidden" id="campaignId" value="0" />
                    
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Lưu ý:</strong> Tên chiến dịch phải duy nhất và không trùng với chiến dịch đã tồn tại.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-tag me-1"></i>Tên chiến dịch <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="campaignTitle" required minlength="10" maxlength="200" placeholder="Nhập tên chiến dịch (10-200 ký tự)" />
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <small id="titleFeedback" class="text-muted">Tên chiến dịch phải từ 10-200 ký tự</small>
                                <small id="titleCounter" class="text-muted">0/200</small>
                            </div>
                            <div id="titleError" class="invalid-feedback d-block" style="display: none !important;"></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-folder me-1"></i>Danh mục <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="campaignCategory" required>
                                <option value="">-- Chọn danh mục --</option>
                            </select>
                            <small id="categoryFeedback" class="text-muted">Bắt buộc chọn danh mục để phân loại</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-card-text me-1"></i>Mô tả chi tiết <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="campaignDescription" rows="4" required minlength="50" placeholder="Mô tả chi tiết về chiến dịch, hoàn cảnh, mục đích sử dụng quỹ..."></textarea>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <small id="descFeedback" class="text-muted">Tối thiểu 50 ký tự. Mô tả rõ ràng giúp tăng độ tin cậy.</small>
                            <small id="descCounter" class="text-muted">0 ký tự</small>
                        </div>
                        <div id="descError" class="invalid-feedback d-block" style="display: none !important;"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-cash me-1"></i>Mục tiêu (VNĐ) <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="campaignTarget" required placeholder="Nhập số tiền mục tiêu" />
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <small id="targetFeedback" class="text-muted">Tối thiểu 100.000 VNĐ</small>
                                <small id="targetFormatted" class="text-primary fw-semibold"></small>
                            </div>
                            <div id="targetError" class="invalid-feedback d-block" style="display: none !important;"></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-calendar-event me-1"></i>Ngày bắt đầu
                            </label>
                            <input type="date" class="form-control" id="campaignStartDate" />
                            <small id="startDateFeedback" class="text-muted">Mặc định là hôm nay</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-calendar-check me-1"></i>Ngày kết thúc
                            </label>
                            <input type="date" class="form-control" id="campaignEndDate" />
                            <small id="endDateFeedback" class="text-muted">Thời hạn gây quỹ (không bắt buộc)</small>
                            <div id="dateError" class="invalid-feedback d-block" style="display: none !important;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-image me-1"></i>URL Ảnh đại diện
                            </label>
                            <input type="url" class="form-control" id="campaignThumbnail" placeholder="https://example.com/image.jpg" />
                            <small class="text-muted">Link ảnh minh họa cho chiến dịch (JPG, PNG)</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-arrow-repeat me-1"></i>Xử lý tiền dư
                            </label>
                            <select class="form-select" id="campaignExcessOption">
                                <option value="next_case">Chuyển cho hoàn cảnh tiếp theo</option>
                                <option value="reserve_fund">Chuyển vào quỹ dự phòng</option>
                            </select>
                            <small class="text-muted">Cách xử lý khi vượt mục tiêu</small>
                        </div>
                    </div>
                    <div class="row" id="statusRow" style="display: none;">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="bi bi-toggle2-on me-1"></i>Trạng thái
                            </label>
                            <select class="form-select" id="campaignStatus">
                                <option value="active">Hoạt động</option>
                                <option value="pending_approval">Chờ duyệt</option>
                                <option value="draft">Nháp</option>
                                <option value="completed">Đã hoàn thành</option>
                                <option value="paused">Tạm dừng</option>
                                <option value="rejected">Từ chối</option>
                                <option value="locked">Bị khóa</option>
                            </select>
                            <small class="text-muted">Thay đổi trạng thái chiến dịch</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveCampaign()">
                    <i class="bi bi-check-lg me-1"></i>Lưu
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let campaignModal;
let categories = [];
let validationState = {
    title: false,
    description: false,
    target: false,
    category: false,
    dates: true
};
let checkTitleTimer;

document.addEventListener('DOMContentLoaded', function() {
    campaignModal = new bootstrap.Modal(document.getElementById('campaignModal'));
    loadCategories();
    setupRealTimeValidation();
});

// ============== REAL-TIME VALIDATION ==============
function setupRealTimeValidation() {
    const titleInput = document.getElementById('campaignTitle');
    const descInput = document.getElementById('campaignDescription');
    const targetInput = document.getElementById('campaignTarget');
    const categorySelect = document.getElementById('campaignCategory');
    const startDateInput = document.getElementById('campaignStartDate');
    const endDateInput = document.getElementById('campaignEndDate');

    // Title validation
    titleInput.addEventListener('input', function() {
        validateTitle(this.value);
    });

    // Description validation
    descInput.addEventListener('input', function() {
        validateDescription(this.value);
    });

    // Target amount validation
    targetInput.addEventListener('input', function() {
        // Chỉ cho phép nhập số
        let value = this.value.replace(/[^\d]/g, '');
        this.value = value;
        validateTarget(value);
    });

    // Category validation
    categorySelect.addEventListener('change', function() {
        validateCategory(this.value);
    });

    // Date validation
    startDateInput.addEventListener('change', validateDates);
    endDateInput.addEventListener('change', validateDates);
}

function validateCategory(value) {
    const select = document.getElementById('campaignCategory');
    const feedback = document.getElementById('categoryFeedback');
    
    select.classList.remove('is-valid', 'is-invalid');
    
    if (!value) {
        select.classList.add('is-invalid');
        feedback.className = 'text-danger';
        feedback.innerHTML = '<i class="bi bi-x-circle me-1"></i>Vui lòng chọn danh mục';
        validationState.category = false;
    } else {
        select.classList.add('is-valid');
        feedback.className = 'text-success';
        feedback.innerHTML = '<i class="bi bi-check-circle me-1"></i>Đã chọn danh mục';
        validationState.category = true;
    }
    updateSaveButton();
}

async function validateTitle(value) {
    const input = document.getElementById('campaignTitle');
    const feedback = document.getElementById('titleFeedback');
    const counter = document.getElementById('titleCounter');
    const errorDiv = document.getElementById('titleError');
    const campaignId = document.getElementById('campaignId').value;
        
    const length = value.trim().length;
    counter.textContent = `${length}/200`;

    // Reset
    input.classList.remove('is-valid', 'is-invalid');
    errorDiv.style.display = 'none';

    if (length === 0) {
        feedback.className = 'text-muted';
        feedback.textContent = 'Tên chiến dịch phải từ 10-200 ký tự';
        counter.className = 'text-muted';
        validationState.title = false;
        updateSaveButton();
        return;
    }
    
    if (length < 10) {
        input.classList.add('is-invalid');
        feedback.className = 'text-danger';
        feedback.innerHTML = `<i class="bi bi-x-circle me-1"></i>Cần thêm ${10 - length} ký tự nữa`;
        counter.className = 'text-danger';
        validationState.title = false;
        updateSaveButton();
        return;
    }
    
    if (length > 200) {
        input.classList.add('is-invalid');
        feedback.className = 'text-danger';
        feedback.innerHTML = `<i class="bi bi-x-circle me-1"></i>Vượt quá ${length - 200} ký tự`;
        counter.className = 'text-danger';
        validationState.title = false;
        updateSaveButton();
        return;
    }

    // Check uniqueness (debounce)
    clearTimeout(checkTitleTimer);
    feedback.className = 'text-info';
    feedback.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Đang kiểm tra...';
    
    checkTitleTimer = setTimeout(async () => {
        try {
            const excludeId = campaignId !== '0' ? `&excludeCampaignId=${campaignId}` : '';
            const response = await fetch(`@Url.Action("CheckTitleExists", "AdminCampaigns", new { area = "" })?title=${encodeURIComponent(value.trim())}${excludeId}`);
            const res = await response.json();
            
            if (res.exists) {
                input.classList.add('is-invalid');
                feedback.className = 'text-danger';
                feedback.innerHTML = '<i class="bi bi-x-circle me-1"></i>Tên chiến dịch đã tồn tại';
                counter.className = 'text-danger';
                validationState.title = false;
            } else {
                input.classList.add('is-valid');
                feedback.className = 'text-success';
                feedback.innerHTML = '<i class="bi bi-check-circle me-1"></i>Tên chiến dịch hợp lệ';
                counter.className = 'text-success';
                validationState.title = true;
            }
        } catch (error) {
            // On error, assume valid and let server validate
            input.classList.add('is-valid');
            feedback.className = 'text-success';
            feedback.innerHTML = '<i class="bi bi-check-circle me-1"></i>Độ dài hợp lệ';
            counter.className = 'text-success';
            validationState.title = true;
        }
        updateSaveButton();
    }, 500);
}

function validateDescription(value) {
    const input = document.getElementById('campaignDescription');
    const feedback = document.getElementById('descFeedback');
    const counter = document.getElementById('descCounter');
    const errorDiv = document.getElementById('descError');
        
    const length = value.trim().length;
    counter.textContent = `${length} ký tự`;

    // Reset
    input.classList.remove('is-valid', 'is-invalid');
    errorDiv.style.display = 'none';

    if (length === 0) {
        feedback.className = 'text-muted';
        feedback.textContent = 'Tối thiểu 50 ký tự. Mô tả rõ ràng giúp tăng độ tin cậy.';
        counter.className = 'text-muted';
        validationState.description = false;
    } else if (length < 50) {
        input.classList.add('is-invalid');
        feedback.className = 'text-danger';
        feedback.innerHTML = `<i class="bi bi-x-circle me-1"></i>Cần thêm ${50 - length} ký tự nữa`;
        counter.className = 'text-danger';
        validationState.description = false;
    } else {
        input.classList.add('is-valid');
        feedback.className = 'text-success';
        feedback.innerHTML = `<i class="bi bi-check-circle me-1"></i>Mô tả đủ chi tiết`;
        counter.className = 'text-success';
        validationState.description = true;
    }

    updateSaveButton();
}

function validateTarget(value) {
    const input = document.getElementById('campaignTarget');
    const feedback = document.getElementById('targetFeedback');
    const formatted = document.getElementById('targetFormatted');
    const errorDiv = document.getElementById('targetError');
        
    const amount = parseInt(value) || 0;

    // Reset
    input.classList.remove('is-valid', 'is-invalid');
    errorDiv.style.display = 'none';

    if (amount === 0) {
        feedback.className = 'text-muted';
        feedback.textContent = 'Tối thiểu 100.000 VNĐ';
        formatted.textContent = '';
        validationState.target = false;
    } else if (amount < 100000) {
        input.classList.add('is-invalid');
        feedback.className = 'text-danger';
        feedback.innerHTML = `<i class="bi bi-x-circle me-1"></i>Số tiền tối thiểu là 100.000 VNĐ`;
        formatted.textContent = formatCurrency(amount);
        formatted.className = 'text-danger fw-semibold';
        validationState.target = false;
    } else if (amount > 100000000000) { // 100 tỷ
        input.classList.add('is-invalid');
        feedback.className = 'text-danger';
        feedback.innerHTML = `<i class="bi bi-x-circle me-1"></i>Số tiền vượt quá giới hạn`;
        formatted.textContent = formatCurrency(amount);
        formatted.className = 'text-danger fw-semibold';
        validationState.target = false;
    } else {
        input.classList.add('is-valid');
        feedback.className = 'text-success';
        feedback.innerHTML = `<i class="bi bi-check-circle me-1"></i>Số tiền hợp lệ`;
        formatted.textContent = formatCurrency(amount);
        formatted.className = 'text-primary fw-semibold';
        validationState.target = true;
    }

    updateSaveButton();
}

function validateDates() {
    const startInput = document.getElementById('campaignStartDate');
    const endInput = document.getElementById('campaignEndDate');
    const startFeedback = document.getElementById('startDateFeedback');
    const endFeedback = document.getElementById('endDateFeedback');
    const dateError = document.getElementById('dateError');

    const startDate = startInput.value ? new Date(startInput.value) : null;
    const endDate = endInput.value ? new Date(endInput.value) : null;
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Reset
    startInput.classList.remove('is-valid', 'is-invalid');
    endInput.classList.remove('is-valid', 'is-invalid');
    dateError.style.display = 'none';
    validationState.dates = true;

    if (startDate) {
        startInput.classList.add('is-valid');
        startFeedback.className = 'text-success';
        startFeedback.innerHTML = `<i class="bi bi-check-circle me-1"></i>${formatDate(startDate)}`;
    } else {
        startFeedback.className = 'text-muted';
        startFeedback.textContent = 'Mặc định là hôm nay';
    }

    if (endDate) {
        if (startDate && endDate <= startDate) {
            endInput.classList.add('is-invalid');
            endFeedback.className = 'text-danger';
            endFeedback.innerHTML = `<i class="bi bi-x-circle me-1"></i>Ngày kết thúc phải sau ngày bắt đầu`;
            validationState.dates = false;
        } else if (endDate < today) {
            endInput.classList.add('is-invalid');
            endFeedback.className = 'text-danger';
            endFeedback.innerHTML = `<i class="bi bi-x-circle me-1"></i>Ngày kết thúc không thể trong quá khứ`;
            validationState.dates = false;
        } else {
            endInput.classList.add('is-valid');
            endFeedback.className = 'text-success';
            const days = Math.ceil((endDate - (startDate || today)) / (1000 * 60 * 60 * 24));
            endFeedback.innerHTML = `<i class="bi bi-check-circle me-1"></i>Còn ${days} ngày gây quỹ`;
        }
    } else {
        endFeedback.className = 'text-muted';
        endFeedback.textContent = 'Thời hạn gây quỹ (không bắt buộc)';
    }

    updateSaveButton();
}

function updateSaveButton() {
    const saveBtn = document.querySelector('#campaignModal .btn-primary');
    const isValid = validationState.title && validationState.description && validationState.target && validationState.category && validationState.dates;
        
    if (isValid) {
        saveBtn.disabled = false;
        saveBtn.classList.remove('btn-secondary');
        saveBtn.classList.add('btn-primary');
    } else {
        // Chỉ disable khi form đã được tương tác
        const titleLength = document.getElementById('campaignTitle').value.trim().length;
        const descLength = document.getElementById('campaignDescription').value.trim().length;
        const targetVal = document.getElementById('campaignTarget').value;
        const categoryVal = document.getElementById('campaignCategory').value;
            
        if (titleLength > 0 || descLength > 0 || targetVal || categoryVal) {
            saveBtn.disabled = !isValid;
        }
    }
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
}

function formatDate(date) {
    return date.toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

function resetValidationState() {
    validationState = { title: false, description: false, target: false, category: false, dates: true };
        
    // Reset all inputs
    ['campaignTitle', 'campaignDescription', 'campaignTarget', 'campaignCategory', 'campaignStartDate', 'campaignEndDate'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('is-valid', 'is-invalid');
    });

    // Reset feedbacks
    document.getElementById('titleFeedback').className = 'text-muted';
    document.getElementById('titleFeedback').textContent = 'Tên chiến dịch phải từ 10-200 ký tự';
    document.getElementById('titleCounter').className = 'text-muted';
    document.getElementById('titleCounter').textContent = '0/200';

    document.getElementById('descFeedback').className = 'text-muted';
    document.getElementById('descFeedback').textContent = 'Tối thiểu 50 ký tự. Mô tả rõ ràng giúp tăng độ tin cậy.';
    document.getElementById('descCounter').className = 'text-muted';
    document.getElementById('descCounter').textContent = '0 ký tự';
    
    document.getElementById('categoryFeedback').className = 'text-muted';
    document.getElementById('categoryFeedback').textContent = 'Bắt buộc chọn danh mục để phân loại';

    document.getElementById('targetFeedback').className = 'text-muted';
    document.getElementById('targetFeedback').textContent = 'Tối thiểu 100.000 VNĐ';
    document.getElementById('targetFormatted').textContent = '';

    document.getElementById('startDateFeedback').className = 'text-muted';
    document.getElementById('startDateFeedback').textContent = 'Mặc định là hôm nay';
    document.getElementById('endDateFeedback').className = 'text-muted';
    document.getElementById('endDateFeedback').textContent = 'Thời hạn gây quỹ (không bắt buộc)';


    // Enable save button
    const saveBtn = document.querySelector('#campaignModal .btn-primary');
    saveBtn.disabled = false;
}

// ============== END VALIDATION ==============

async function loadCategories() {
    try {
        const response = await fetch('@Url.Action("GetCategories", "AdminCampaigns", new { area = "" })');
        const res = await response.json();
        if (res.success) {
            categories = res.categories;
            const select = document.getElementById('campaignCategory');
            select.innerHTML = '<option value="">-- Chọn danh mục --</option>';
            categories.forEach(c => {
                select.innerHTML += `<option value="${c.categoryId}">${c.name}</option>`;
            });
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function showCreateCampaignModal() {
    document.getElementById('campaignModalTitle').textContent = 'Thêm chiến dịch mới';
    document.getElementById('campaignForm').reset();
    document.getElementById('campaignId').value = '0';
    document.getElementById('statusRow').style.display = 'none';
    document.getElementById('campaignStartDate').value = new Date().toISOString().split('T')[0];
    resetValidationState();
    campaignModal.show();
}

async function editCampaign(id) {
    Swal.fire({
        title: 'Đang tải...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        const response = await fetch(`@Url.Action("Get", "AdminCampaigns", new { area = "" })?id=${id}`);
        const res = await response.json();
        Swal.close();

        if (res.success) {
            const c = res.campaign;
            document.getElementById('campaignModalTitle').textContent = 'Sửa chiến dịch';
            document.getElementById('campaignId').value = c.campaignId;
            document.getElementById('campaignTitle').value = c.title;
            document.getElementById('campaignDescription').value = c.description;
            document.getElementById('campaignTarget').value = c.targetAmount;
            document.getElementById('campaignCategory').value = c.categoryId || '';
            document.getElementById('campaignStartDate').value = c.startDate || '';
            document.getElementById('campaignEndDate').value = c.endDate || '';
            document.getElementById('campaignThumbnail').value = c.thumbnailUrl || '';
            document.getElementById('campaignExcessOption').value = c.excessFundOption || 'next_case';
            document.getElementById('campaignStatus').value = c.status || 'active';
            document.getElementById('statusRow').style.display = 'flex';
            
            // Trigger validation for existing data
            validateTitle(c.title);
            validateDescription(c.description);
            validateTarget(c.targetAmount.toString());
            validateDates();
            
            campaignModal.show();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: res.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi kết nối',
                text: 'Không thể tải thông tin chiến dịch',
                confirmButtonColor: '#dc3545'
            });
        }
    }

    async function saveCampaign() {
        const id = document.getElementById('campaignId').value;
        const isEdit = id !== '0';

        const title = document.getElementById('campaignTitle').value.trim();
        const description = document.getElementById('campaignDescription').value.trim();
        const targetAmount = document.getElementById('campaignTarget').value;

        // Trigger validation one more time
        validateTitle(title);
        validateDescription(description);
        validateTarget(targetAmount);
        validateDates();

        // Check validation state
        if (!validationState.title || !validationState.description || !validationState.target || !validationState.dates) {
            let errorMessages = [];
            if (!validationState.title) errorMessages.push('Tên chiến dịch phải từ 10-200 ký tự');
            if (!validationState.description) errorMessages.push('Mô tả chiến dịch phải có ít nhất 50 ký tự');
            if (!validationState.target) errorMessages.push('Mục tiêu quyên góp tối thiểu là 100.000đ');
            if (!validationState.dates) errorMessages.push('Ngày kết thúc phải sau ngày bắt đầu');
            
            Swal.fire({
                icon: 'warning',
                title: 'Thông tin không hợp lệ',
                html: `<ul class="text-start">${errorMessages.map(m => `<li>${m}</li>`).join('')}</ul>`,
                confirmButtonColor: '#ffc107'
            });
            return;
        }

        Swal.fire({
            title: 'Đang lưu...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        const startDate = document.getElementById('campaignStartDate').value;
        const endDate = document.getElementById('campaignEndDate').value;

        const formData = new FormData();
        if (isEdit) formData.append('campaignId', id);
        formData.append('title', title);
        formData.append('description', description);
        formData.append('targetAmount', targetAmount);
            
        const categoryId = document.getElementById('campaignCategory').value;
        if (categoryId) formData.append('categoryId', categoryId);
            
        if (startDate) formData.append('startDate', startDate);
        if (endDate) formData.append('endDate', endDate);
            
        const thumbnail = document.getElementById('campaignThumbnail').value;
        if (thumbnail) formData.append('thumbnailUrl', thumbnail);
            
        formData.append('excessFundOption', document.getElementById('campaignExcessOption').value);
            
        if (isEdit) {
            formData.append('status', document.getElementById('campaignStatus').value);
        }
            
        formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

        try {
            const url = isEdit ? '@Url.Action("Update", "AdminCampaigns", new { area = "" })' : '@Url.Action("Create", "AdminCampaigns", new { area = "" })';
            const response = await fetch(url, {
                method: 'POST',
                body: formData
            });
                
            const res = await response.json();
            if (res.success) {
                campaignModal.hide();
                await Swal.fire({
                    icon: 'success',
                    title: 'Thành công!',
                    text: res.message,
                    confirmButtonColor: '#198754'
                });
                location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: res.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        } catch (error) {
            console.error('Save campaign error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Lỗi kết nối',
                text: 'Đã xảy ra lỗi, vui lòng thử lại',
                confirmButtonColor: '#dc3545'
            });
        }
    }

    async function deleteCampaign(campaignId, title) {
        const result = await Swal.fire({
            icon: 'warning',
            title: 'Xóa chiến dịch',
            html: `Bạn có chắc chắn muốn xóa chiến dịch "<strong>${title}</strong>"?<br><small class="text-muted">Hành động này không thể hoàn tác!</small>`,
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-trash me-1"></i>Xóa',
            cancelButtonText: 'Hủy',
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            reverseButtons: true
        });

        if (!result.isConfirmed) return;

        Swal.fire({
            title: 'Đang xóa...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        const formData = new FormData();
        formData.append('campaignId', campaignId);
        formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

        try {
            const response = await fetch('@Url.Action("Delete", "AdminCampaigns", new { area = "" })', {
                method: 'POST',
                body: formData
            });
                
            const res = await response.json();
            if (res.success) {
                await Swal.fire({
                    icon: 'success',
                    title: 'Đã xóa!',
                    text: res.message,
                    confirmButtonColor: '#198754'
                });
                location.reload();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Không thể xóa',
                    text: res.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi kết nối',
                text: 'Đã xảy ra lỗi, vui lòng thử lại',
                confirmButtonColor: '#dc3545'
            });
        }
    }

    async function approveCampaign(campaignId) {
            const result = await Swal.fire({
                icon: 'question',
                title: 'Phê duyệt chiến dịch',
                text: 'Bạn có chắc chắn muốn PHÊ DUYỆT chiến dịch này?',
                showCancelButton: true,
                confirmButtonText: '<i class="bi bi-check-lg me-1"></i>Phê duyệt',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#198754',
                cancelButtonColor: '#6c757d',
                reverseButtons: true
            });

            if (!result.isConfirmed) return;
            
            Swal.fire({
                title: 'Đang xử lý...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            const formData = new FormData();
            formData.append('campaignId', campaignId);
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
            
            try {
                const response = await fetch('@Url.Action("Approve", "AdminCampaigns", new { area = "" })', {
                    method: 'POST',
                    body: formData
                });
                
                const res = await response.json();
                if (res.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Đã phê duyệt!',
                        text: res.message,
                        confirmButtonColor: '#198754'
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: res.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi kết nối',
                    text: 'Đã xảy ra lỗi, vui lòng thử lại',
                    confirmButtonColor: '#dc3545'
                });
            }
        }
        
        async function rejectCampaign(campaignId) {
            const { value: note } = await Swal.fire({
                icon: 'warning',
                title: 'Từ chối chiến dịch',
                input: 'textarea',
                inputLabel: 'Lý do từ chối',
                inputPlaceholder: 'Nhập lý do từ chối chiến dịch...',
                inputAttributes: {
                    'aria-label': 'Lý do từ chối'
                },
                showCancelButton: true,
                confirmButtonText: '<i class="bi bi-x-lg me-1"></i>Từ chối',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                inputValidator: (value) => {
                    if (!value || value.trim() === '') {
                        return 'Vui lòng nhập lý do từ chối!';
                    }
                }
            });

            if (!note) return;
            
            Swal.fire({
                title: 'Đang xử lý...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            const formData = new FormData();
            formData.append('campaignId', campaignId);
            formData.append('note', note);
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
            
            try {
                const response = await fetch('@Url.Action("Reject", "AdminCampaigns", new { area = "" })', {
                    method: 'POST',
                    body: formData
                });
                
                const res = await response.json();
                if (res.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Đã từ chối!',
                        text: res.message,
                        confirmButtonColor: '#198754'
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: res.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi kết nối',
                    text: 'Đã xảy ra lỗi, vui lòng thử lại',
                    confirmButtonColor: '#dc3545'
                });
            }
        }
        
        async function closeCampaign(campaignId) {
            const { value: note } = await Swal.fire({
                icon: 'warning',
                title: 'Đóng chiến dịch',
                input: 'textarea',
                inputLabel: 'Lý do đóng chiến dịch',
                inputPlaceholder: 'Nhập lý do đóng chiến dịch...',
                inputAttributes: {
                    'aria-label': 'Lý do đóng'
                },
                showCancelButton: true,
                confirmButtonText: '<i class="bi bi-pause-circle me-1"></i>Đóng chiến dịch',
                cancelButtonText: 'Hủy',
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                inputValidator: (value) => {
                    if (!value || value.trim() === '') {
                        return 'Vui lòng nhập lý do đóng chiến dịch!';
                    }
                }
            });

            if (!note) return;
            
            Swal.fire({
                title: 'Đang xử lý...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            const formData = new FormData();
            formData.append('campaignId', campaignId);
            formData.append('note', note);
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
            
            try {
                const response = await fetch('@Url.Action("Close", "AdminCampaigns", new { area = "" })', {
                    method: 'POST',
                    body: formData
                });
                
                const res = await response.json();
                if (res.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Đã đóng chiến dịch!',
                        text: res.message,
                        confirmButtonColor: '#198754'
                    });
                    location.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: res.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi kết nối',
                    text: 'Đã xảy ra lỗi, vui lòng thử lại',
                    confirmButtonColor: '#dc3545'
                });
            }
        }
    </script>
    @Html.AntiForgeryToken()
}
