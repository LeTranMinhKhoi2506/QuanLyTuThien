@model List<TuThien.Models.User>
@{
    ViewData["Title"] = "Quản lý người dùng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-people me-2"></i>Danh sách người dùng</span>
        <div>
            <span class="badge bg-secondary me-2">Tổng: @Model.Count</span>
            <button type="button" class="btn btn-success btn-sm" onclick="showCreateUserModal()">
                <i class="bi bi-plus-lg me-1"></i>Thêm người dùng
            </button>
        </div>
    </div>
    <div class="card-body">
        <table id="usersTable" class="table table-hover align-middle w-100">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Thông tin</th>
                    <th>Liên hệ</th>
                    <th>Vai trò</th>
                    <th>Trạng thái</th>
                    <th>Ngày tạo</th>
                    <th class="text-center">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model)
                {
                    <tr>
                        <td><code>@user.UserId</code></td>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="avatar bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    @user.Username[0].ToString().ToUpper()
                                </div>
                                <div>
                                    <div class="fw-semibold">@user.Username</div>
                                    <small class="text-muted">@user.UserProfile?.FullName</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>@user.Email</div>
                            <small class="text-muted">@user.PhoneNumber</small>
                        </td>
                        <td data-order="@user.Role">
                            <select class="form-select form-select-sm role-select" data-user-id="@user.UserId" style="width: 140px;">
                                <option value="user" selected="@(user.Role == "user")">Người dùng</option>
                                <option value="charity_org" selected="@(user.Role == "charity_org")">Tổ chức từ thiện</option>
                                <option value="admin" selected="@(user.Role == "admin")">Admin</option>
                            </select>
                        </td>
                        <td data-order="@user.Status">
                            @{
                                var statusClass = user.Status switch
                                {
                                    "active" => "badge-active",
                                    "locked" => "badge-locked",
                                    _ => "badge-pending"
                                };
                                var statusText = user.Status switch
                                {
                                    "active" => "Hoạt động",
                                    "locked" => "Đã khóa",
                                    _ => "Chờ xác thực"
                                };
                            }
                            <span class="badge @statusClass">@statusText</span>
                        </td>
                        <td data-order="@user.CreatedAt?.ToString("yyyy-MM-dd")">
                            <small>@user.CreatedAt?.ToString("dd/MM/yyyy")</small>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary" 
                                        onclick="editUser(@user.UserId)" title="Sửa">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                @if (user.Status == "active")
                                {
                                    <button type="button" class="btn btn-outline-danger btn-status" 
                                            data-user-id="@user.UserId" data-status="locked" title="Khóa tài khoản">
                                        <i class="bi bi-lock"></i>
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-outline-success btn-status" 
                                            data-user-id="@user.UserId" data-status="active" title="Mở khóa">
                                        <i class="bi bi-unlock"></i>
                                    </button>
                                }
                                <button type="button" class="btn btn-outline-danger" 
                                        onclick="deleteUser(@user.UserId, '@user.Username.Replace("'", "\\'")')" title="Xóa">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@* Include Modal Partial *@
<partial name="Users/_UserModal" />

@section Scripts {
    @* Include external JS file *@
    <script src="~/js/admin-users.js" asp-append-version="true"></script>
    
    <script>
        // Initialize with API URLs
        document.addEventListener('DOMContentLoaded', function() {
            initUserManagement({
                checkUsername: '@Url.Action("CheckUsernameExists", "AdminUsers")',
                checkEmail: '@Url.Action("CheckEmailExists", "AdminUsers")',
                get: '@Url.Action("Get", "AdminUsers")',
                create: '@Url.Action("Create", "AdminUsers")',
                update: '@Url.Action("Update", "AdminUsers")',
                delete: '@Url.Action("Delete", "AdminUsers")',
                updateStatus: '@Url.Action("UpdateStatus", "AdminUsers")',
                updateRole: '@Url.Action("UpdateRole", "AdminUsers")'
            });
        });
    </script>
}
