@using TuThien.Configuration
@using TuThien.Models
@{
    ViewData["Title"] = "Quyên góp";
    Layout = "_Layout";
    var selectedCampaign = ViewBag.SelectedCampaign as Campaign;
    var campaigns = ViewBag.Campaigns as List<Campaign> ?? new List<Campaign>();
    var donationSettings = ViewBag.DonationSettings as DonationSettings ?? new DonationSettings();
    
    // Calculate current amount for selected campaign
    decimal current = selectedCampaign?.CurrentAmount ?? 0m;
    decimal target = selectedCampaign?.TargetAmount ?? 0m;
}

<div class="container py-5">
    @if (selectedCampaign == null)
    {
        <!-- No Campaign Selected - Show campaign list to choose -->
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-body text-center py-4">
                        <i class="bi bi-heart-fill display-1 text-danger mb-3"></i>
                        <h3>Chọn chiến dịch để quyên góp</h3>
                        <p class="text-muted mb-0">Vui lòng chọn một chiến dịch từ danh sách bên dưới để tiếp tục quyên góp.</p>
                    </div>
                </div>
                
                @if (campaigns.Any())
                {
                    <!-- Search & Filter -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="campaignSearch" placeholder="Tìm kiếm chiến dịch...">
                                        <button class="btn btn-outline-secondary" type="button" id="clearSearch" title="Xóa tìm kiếm">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="categoryFilter">
                                        <option value="">Tất cả danh mục</option>
                                        @{
                                            var categories = campaigns.Where(c => c.Category != null)
                                                                     .Select(c => c.Category)
                                                                     .DistinctBy(c => c!.CategoryId)
                                                                     .OrderBy(c => c!.Name);
                                        }
                                        @foreach (var cat in categories)
                                        {
                                            <option value="@cat!.Name">@cat.Name</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">
                                    <span id="filteredCount">@campaigns.Count</span> / @campaigns.Count chiến dịch
                                </small>
                                <button class="btn btn-link btn-sm p-0 text-decoration-none" id="resetFilters">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>Đặt lại
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Campaign List -->
                    <div class="row g-3" id="campaignList">
                        @foreach (var campaign in campaigns)
                        {
                            var percent = campaign.TargetAmount > 0
                                ? Math.Min(100, (double)((campaign.CurrentAmount ?? 0) / campaign.TargetAmount) * 100)
                                : 0;
                            <div class="col-md-6 campaign-item" 
                                 data-campaign-title="@campaign.Title"
                                 data-campaign-category="@campaign.Category?.Name">
                                <div class="card h-100 shadow-sm hover-shadow">
                                    <div class="position-relative">
                                        @if (!string.IsNullOrEmpty(campaign.ThumbnailUrl))
                                        {
                                            <img src="@campaign.ThumbnailUrl" class="card-img-top" alt="@campaign.Title" style="height: 160px; object-fit: cover;">
                                        }
                                        else
                                        {
                                            <div class="bg-light d-flex align-items-center justify-content-center" style="height: 160px;">
                                                <i class="bi bi-image display-4 text-muted"></i>
                                            </div>
                                        }
                                        <span class="badge bg-success position-absolute top-0 end-0 m-2">Đang hoạt động</span>
                                    </div>
                                    <div class="card-body">
                                        <h6 class="card-title campaign-title-text mb-2">@campaign.Title</h6>
                                        <small class="text-muted d-block mb-2">
                                            <i class="bi bi-tag me-1"></i>@(campaign.Category?.Name ?? "Chưa phân loại")
                                        </small>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between small mb-1">
                                                <span class="text-success fw-semibold">@((campaign.CurrentAmount ?? 0).ToString("N0"))đ</span>
                                                <span class="text-muted">/ @campaign.TargetAmount.ToString("N0")đ</span>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-success" style="width: @percent%"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-white border-0 pt-0">
                                        <a href="/donate/@campaign.CampaignId" class="btn btn-success w-100">
                                            <i class="bi bi-heart-fill me-1"></i>Quyên góp ngay
                                        </a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- No results message -->
                    <div class="card shadow-sm d-none" id="noResultsMessage">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-search display-4 text-muted"></i>
                            <p class="mt-3 mb-2">Không tìm thấy chiến dịch phù hợp</p>
                            <button class="btn btn-outline-primary btn-sm" id="clearFiltersBtn">
                                <i class="bi bi-arrow-counterclockwise me-1"></i>Xóa bộ lọc
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <div class="card shadow-sm">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-inbox display-1 text-muted"></i>
                            <p class="mt-3 mb-4">Chưa có chiến dịch nào đang hoạt động</p>
                            <a href="@Url.Action("Index", "TrangChu")" class="btn btn-primary">
                                <i class="bi bi-house me-2"></i>Về trang chủ
                            </a>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <!-- Campaign Selected - Show donation form -->
        <div class="row justify-content-center">
            <!-- Sidebar - Campaign Info -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm sticky-top" style="top: 100px;">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Thông tin chiến dịch</h6>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(selectedCampaign.ThumbnailUrl))
                        {
                            <img src="@selectedCampaign.ThumbnailUrl" class="img-fluid rounded mb-3" alt="@selectedCampaign.Title">
                        }
                        <h6 class="card-title">@selectedCampaign.Title</h6>
                        <small class="text-muted d-block mb-3">
                            <i class="bi bi-tag me-1"></i>@(selectedCampaign.Category?.Name ?? "Chưa phân loại")
                        </small>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Đã quyên góp</small>
                                <small class="fw-bold text-success">@current.ToString("N0") ₫</small>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-muted">Mục tiêu</small>
                                <small class="fw-bold">@target.ToString("N0") ₫</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                @{
                                    var sidebarPercent = target > 0 
                                        ? Math.Min(100, (double)(current / target) * 100) 
                                        : 0;
                                }
                                <div class="progress-bar bg-success" style="width: @sidebarPercent%"></div>
                            </div>
                            <small class="text-muted d-block mt-1">@sidebarPercent.ToString("F1")% hoàn thành</small>
                        </div>
                        <a href="@Url.Action("Details", "Campaign", new { id = selectedCampaign.CampaignId })" 
                           class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-eye me-1"></i>Xem chi tiết chiến dịch
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Content - Donation Form -->
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0"><i class="bi bi-heart-fill me-2"></i>Quyên góp ngay</h4>
                    </div>
                    <div class="card-body">
                        <!-- Campaign Info Panel -->
                        <div class="alert alert-info mb-4">
                            <h5 class="alert-heading mb-2">@selectedCampaign.Title</h5>
                            <p class="mb-1">
                                Đã quyên góp: <strong>@current.ToString("N0")</strong> VNĐ 
                                / <span>@target.ToString("N0")</span> VNĐ
                            </p>
                            <div class="progress" style="height: 10px;">
                                @{
                                    var mainPercent = target > 0
                                        ? Math.Min(100, (double)(current / target) * 100)
                                        : 0;
                                }
                                <div class="progress-bar bg-success" style="width: @mainPercent%"></div>
                            </div>
                        </div>

                        <form id="donationForm" novalidate>
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="CampaignId" id="campaignIdInput" value="@selectedCampaign.CampaignId" />
                            
                            <!-- Số tiền quyên góp -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Số tiền quyên góp <span class="text-danger">*</span></label>
                                <div class="row g-2 mb-3">
                                    <div class="col-4 col-md-2">
                                        <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="50000">50K</button>
                                    </div>
                                    <div class="col-4 col-md-2">
                                        <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="100000">100K</button>
                                    </div>
                                    <div class="col-4 col-md-2">
                                        <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="200000">200K</button>
                                    </div>
                                    <div class="col-4 col-md-2">
                                        <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="500000">500K</button>
                                    </div>
                                    <div class="col-4 col-md-2">
                                        <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="1000000">1M</button>
                                    </div>
                                    <div class="col-4 col-md-2">
                                        <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="2000000">2M</button>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <input type="number" class="form-control form-control-lg" name="Amount" id="amount" 
                                           placeholder="Nhập số tiền khác..." 
                                           min="@donationSettings.MinAmount" 
                                           max="@donationSettings.MaxAmount" 
                                           step="1000"
                                           required />
                                    <span class="input-group-text">VNĐ</span>
                                </div>
                                <div class="invalid-feedback" id="amountError"></div>
                                <small class="text-muted">Số tiền từ @donationSettings.MinAmount.ToString("N0") đến @donationSettings.MaxAmount.ToString("N0") VNĐ</small>
                            </div>

                            <!-- Lời nhắn -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Lời nhắn (không bắt buộc)</label>
                                <textarea class="form-control" name="Message" id="message" rows="3" 
                                          maxlength="@donationSettings.MaxMessageLength"
                                          placeholder="Gửi lời chúc, động viên đến người nhận..."></textarea>
                                <small class="text-muted"><span id="messageCount">0</span>/@donationSettings.MaxMessageLength ký tự</small>
                            </div>

                            <!-- Quyên góp ẩn danh -->
                            <div class="mb-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="IsAnonymous" id="isAnonymous" value="true">
                                    <label class="form-check-label" for="isAnonymous">
                                        Quyên góp ẩn danh (Tên của bạn sẽ không hiển thị công khai)
                                    </label>
                                </div>
                            </div>

                            <!-- Phương thức thanh toán -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Phương thức thanh toán <span class="text-danger">*</span></label>
                                <div class="row g-3">
                                    <div class="col-12">
                                        <div class="form-check payment-method-card">
                                            <input class="form-check-input" type="radio" name="PaymentMethod" id="payMoMo" value="momo" checked>
                                            <label class="form-check-label w-100" for="payMoMo">
                                                <div class="card border-primary">
                                                    <div class="card-body d-flex align-items-center">
                                                        <img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" 
                                                             alt="MoMo" style="height: 50px; object-fit: contain;" class="me-3">
                                                        <div>
                                                            <h5 class="mb-1">Ví MoMo</h5>
                                                            <small class="text-muted">Thanh toán nhanh chóng qua ví điện tử MoMo</small>
                                                            <span class="badge bg-info ms-2">Đang test</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="invalid-feedback" id="paymentMethodError"></div>
                            </div>

                            <hr>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                    <i class="bi bi-heart me-2"></i>Quyên góp với MoMo
                                </button>
                                <a href="@Url.Action("Details", "Campaign", new { id = selectedCampaign.CampaignId })" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-2"></i>Quay lại chiến dịch
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Thông tin hỗ trợ -->
                <div class="card mt-4 border-0 bg-light">
                    <div class="card-body">
                        <h6><i class="bi bi-shield-check text-success me-2"></i>Cam kết bảo mật</h6>
                        <p class="small text-muted mb-0">
                            Mọi thông tin quyên góp của bạn được bảo mật tuyệt đối. 
                            Giao dịch được xử lý an toàn qua cổng thanh toán MoMo.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
     style="background: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="position-absolute top-50 start-50 translate-middle text-center text-white">
        <div class="spinner-border mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <p>Đang xử lý thanh toán...</p>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const minAmount = @donationSettings.MinAmount;
            const maxAmount = @donationSettings.MaxAmount;
            const maxMessageLength = @donationSettings.MaxMessageLength;

            // ============ Donation Form Logic ============
            // Các nút chọn số tiền nhanh
            $('.amount-btn').on('click', function() {
                const amount = $(this).data('amount');
                $('#amount').val(amount);
                $('.amount-btn').removeClass('btn-primary').addClass('btn-outline-primary');
                $(this).removeClass('btn-outline-primary').addClass('btn-primary');
                validateForm();
            });

            // Validate amount khi nhập
            $('#amount').on('input', function() {
                const amount = parseFloat($(this).val()) || 0;
                $('.amount-btn').removeClass('btn-primary').addClass('btn-outline-primary');
                $(`.amount-btn[data-amount="${amount}"]`).removeClass('btn-outline-primary').addClass('btn-primary');
                validateForm();
            });

            // Đếm ký tự message
            $('#message').on('input', function() {
                const length = $(this).val().length;
                $('#messageCount').text(length);
            });

            // Validate form
            function validateForm() {
                const campaignId = $('#campaignIdInput').val();
                const amount = parseFloat($('#amount').val()) || 0;
                const paymentMethod = $('input[name="PaymentMethod"]:checked').val();

                let isValid = true;
                
                if (!campaignId) isValid = false;
                if (amount < minAmount || amount > maxAmount) isValid = false;
                if (!paymentMethod) isValid = false;

                $('#submitBtn').prop('disabled', !isValid);
                return isValid;
            }

            // Submit form
            $('#donationForm').on('submit', function(e) {
                e.preventDefault();

                if (!validateForm()) return;

                const formData = {
                    CampaignId: parseInt($('#campaignIdInput').val()),
                    Amount: parseFloat($('#amount').val()),
                    Message: $('#message').val(),
                    IsAnonymous: $('#isAnonymous').is(':checked'),
                    PaymentMethod: $('input[name="PaymentMethod"]:checked').val()
                };

                $('#loadingOverlay').removeClass('d-none');
                $('#submitBtn').prop('disabled', true);

                $.ajax({
                    url: '@Url.Action("ProcessDonation", "Donation")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success && response.redirectUrl) {
                            window.location.href = response.redirectUrl;
                        } else {
                            $('#loadingOverlay').addClass('d-none');
                            $('#submitBtn').prop('disabled', false);
                            
                            if (response.requireLogin) {
                                if (confirm(response.message + '\n\nBạn có muốn đăng nhập ngay?')) {
                                    const campaignId = $('#campaignIdInput').val();
                                    window.location.href = '@Url.Action("Login", "Account")' + '?returnUrl=' + encodeURIComponent('/donate/' + campaignId);
                                }
                            } else {
                                alert(response.message || 'Có lỗi xảy ra, vui lòng thử lại.');
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        $('#loadingOverlay').addClass('d-none');
                        $('#submitBtn').prop('disabled', false);
                        alert('Có lỗi xảy ra, vui lòng thử lại.');
                    }
                });
            });

            // Initial validation
            validateForm();

            // ============ Campaign Search & Filter (for no-campaign view) ============
            const $campaignSearch = $('#campaignSearch');
            const $categoryFilter = $('#categoryFilter');
            const $campaignItems = $('.campaign-item');
            const $filteredCount = $('#filteredCount');
            const $noResultsMessage = $('#noResultsMessage');
            const $campaignList = $('#campaignList');

            function filterCampaigns() {
                const searchTerm = $campaignSearch.val().toLowerCase().trim();
                const selectedCategory = $categoryFilter.val();
                let visibleCount = 0;

                $campaignItems.each(function() {
                    const $item = $(this);
                    const title = ($item.data('campaign-title') || '').toString().toLowerCase();
                    const category = $item.data('campaign-category') || '';

                    const matchesSearch = !searchTerm || title.includes(searchTerm);
                    const matchesCategory = !selectedCategory || category === selectedCategory;

                    if (matchesSearch && matchesCategory) {
                        $item.removeClass('d-none');
                        visibleCount++;
                    } else {
                        $item.addClass('d-none');
                    }
                });

                $filteredCount.text(visibleCount);

                if (visibleCount === 0 && $campaignItems.length > 0) {
                    $noResultsMessage.removeClass('d-none');
                    $campaignList.addClass('d-none');
                } else {
                    $noResultsMessage.addClass('d-none');
                    $campaignList.removeClass('d-none');
                }
            }

            let searchTimeout;
            $campaignSearch.on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(filterCampaigns, 200);
            });

            $categoryFilter.on('change', filterCampaigns);

            $('#clearSearch').on('click', function() {
                $campaignSearch.val('');
                filterCampaigns();
            });

            $('#resetFilters, #clearFiltersBtn').on('click', function() {
                $campaignSearch.val('');
                $categoryFilter.val('');
                filterCampaigns();
            });
        });
    </script>
}

<style>
    .payment-method-card .form-check-input {
        display: none;
    }
    
    .payment-method-card .form-check-input:checked + .form-check-label .card {
        border-color: #198754 !important;
        border-width: 2px;
        background-color: #f8fff8;
    }
    
    .amount-btn {
        font-weight: 600;
    }
    
    .hover-shadow {
        transition: all 0.3s ease;
    }
    
    .hover-shadow:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
    }
    
    .campaign-item.d-none {
        display: none !important;
    }
    
    .campaign-title-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
