@using TuThien.Configuration
@using TuThien.Models
@{
    ViewData["Title"] = "Quyên góp";
    Layout = "_Layout";
    var campaigns = ViewBag.Campaigns as List<Campaign> ?? new List<Campaign>();
    var selectedCampaign = ViewBag.SelectedCampaign as Campaign;
    var donationSettings = ViewBag.DonationSettings as DonationSettings ?? new DonationSettings();
}

<div class="container py-5">
    <div class="row">
        <!-- Sidebar - Danh sách chiến dịch -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Chọn chiến dịch</h5>
                </div>
                
                <!-- Search & Filter -->
                <div class="card-body border-bottom pb-3">
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="campaignSearch" placeholder="Tìm kiếm chiến dịch...">
                        <button class="btn btn-outline-secondary" type="button" id="clearSearch" title="Xóa tìm kiếm">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                    <select class="form-select form-select-sm" id="categoryFilter">
                        <option value="">Tất cả danh mục</option>
                        @{
                            var categories = campaigns.Where(c => c.Category != null)
                                                     .Select(c => c.Category)
                                                     .DistinctBy(c => c.CategoryId)
                                                     .OrderBy(c => c.Name);
                        }
                        @foreach (var cat in categories)
                        {
                            <option value="@cat.Name">@cat.Name</option>
                        }
                    </select>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">
                            <span id="filteredCount">@campaigns.Count</span> / @campaigns.Count chiến dịch
                        </small>
                        <button class="btn btn-link btn-sm p-0 text-decoration-none" id="resetFilters">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Đặt lại
                        </button>
                    </div>
                </div>
                
                <div class="card-body p-0" style="max-height: 450px; overflow-y: auto;" id="campaignListContainer">
                    @if (campaigns.Any())
                    {
                        <div class="list-group list-group-flush" id="campaignList">
                            @foreach (var campaign in campaigns)
                            {
                                var isSelected = selectedCampaign?.CampaignId == campaign.CampaignId;
                                var percent = campaign.TargetAmount > 0
                                    ? Math.Min(100, (double)((campaign.CurrentAmount ?? 0) / campaign.TargetAmount) * 100)
                                    : 0;
                                <a href="javascript:void(0)" 
                                   class="list-group-item list-group-item-action campaign-item @(isSelected ? "active" : "")"
                                   data-campaign-id="@campaign.CampaignId"
                                   data-campaign-title="@campaign.Title"
                                   data-campaign-current="@campaign.CurrentAmount"
                                   data-campaign-target="@campaign.TargetAmount"
                                   data-campaign-percent="@percent.ToString("F1")"
                                   data-campaign-category="@campaign.Category?.Name">
                                    <div class="d-flex w-100 justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 campaign-title-text" style="max-width: 200px;">@campaign.Title</h6>
                                            <small class="campaign-category @(isSelected ? "text-white-50" : "text-muted")">
                                                <i class="bi bi-tag me-1"></i>@campaign.Category?.Name
                                            </small>
                                        </div>
                                    </div>
                                    <div class="progress mt-2" style="height: 5px;">
                                        <div class="progress-bar @(isSelected ? "bg-light" : "bg-success")" style="width: @percent%"></div>
                                    </div>
                                    <small class="@(isSelected ? "text-white-50" : "text-muted")">
                                        @((campaign.CurrentAmount ?? 0).ToString("N0")) / @campaign.TargetAmount.ToString("N0") VNĐ
                                    </small>
                                </a>
                            }
                        </div>
                        
                        <!-- No results message -->
                        <div class="p-4 text-center text-muted d-none" id="noResultsMessage">
                            <i class="bi bi-search display-4"></i>
                            <p class="mt-2 mb-0">Không tìm thấy chiến dịch phù hợp</p>
                            <button class="btn btn-link btn-sm" id="clearFiltersBtn">Xóa bộ lọc</button>
                        </div>
                    }
                    else
                    {
                        <div class="p-4 text-center text-muted">
                            <i class="bi bi-inbox display-4"></i>
                            <p class="mt-2">Chưa có chiến dịch nào đang hoạt động</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Main Content - Form quyên góp -->
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="bi bi-heart-fill me-2"></i>Quyên góp ngay</h4>
                </div>
                <div class="card-body">
                    <!-- Campaign Info Panel -->
                    <div id="campaignInfoPanel" class="alert alert-info mb-4 @(selectedCampaign == null ? "d-none" : "")">
                        <h5 class="alert-heading" id="selectedCampaignTitle">@selectedCampaign?.Title</h5>
                        <p class="mb-1">
                            Đã quyên góp: <strong id="selectedCampaignCurrent">@((selectedCampaign?.CurrentAmount ?? 0).ToString("N0"))</strong> VNĐ 
                            / <span id="selectedCampaignTarget">@((selectedCampaign?.TargetAmount ?? 0).ToString("N0"))</span> VNĐ
                        </p>
                        <div class="progress" style="height: 10px;">
                            @{
                                var selectedPercent = selectedCampaign?.TargetAmount > 0
                                    ? Math.Min(100, (double)((selectedCampaign?.CurrentAmount ?? 0) / selectedCampaign.TargetAmount) * 100)
                                    : 0;
                            }
                            <div class="progress-bar bg-success" id="selectedCampaignProgress" style="width: @selectedPercent%"></div>
                        </div>
                    </div>

                    <!-- No Campaign Selected Message -->
                    <div id="noCampaignMessage" class="alert alert-warning @(selectedCampaign != null ? "d-none" : "")">
                        <i class="bi bi-info-circle me-2"></i>Vui lòng chọn một chiến dịch từ danh sách bên trái để quyên góp.
                    </div>

                    <form id="donationForm" novalidate>
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="CampaignId" id="campaignIdInput" value="@selectedCampaign?.CampaignId" />
                        
                        <!-- Số tiền quyên góp -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Số tiền quyên góp <span class="text-danger">*</span></label>
                            <div class="row g-2 mb-3">
                                <div class="col-4 col-md-2">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="50000">50K</button>
                                </div>
                                <div class="col-4 col-md-2">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="100000">100K</button>
                                </div>
                                <div class="col-4 col-md-2">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="200000">200K</button>
                                </div>
                                <div class="col-4 col-md-2">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="500000">500K</button>
                                </div>
                                <div class="col-4 col-md-2">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="1000000">1M</button>
                                </div>
                                <div class="col-4 col-md-2">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="2000000">2M</button>
                                </div>
                            </div>
                            <div class="input-group">
                                <input type="number" class="form-control form-control-lg" name="Amount" id="amount" 
                                       placeholder="Nhập số tiền khác..." 
                                       min="@donationSettings.MinAmount" 
                                       max="@donationSettings.MaxAmount" 
                                       step="1000"
                                       required />
                                <span class="input-group-text">VNĐ</span>
                            </div>
                            <div class="invalid-feedback" id="amountError"></div>
                            <small class="text-muted">Số tiền từ @donationSettings.MinAmount.ToString("N0") đến @donationSettings.MaxAmount.ToString("N0") VNĐ</small>
                        </div>

                        <!-- Lời nhắn -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Lời nhắn (không bắt buộc)</label>
                            <textarea class="form-control" name="Message" id="message" rows="3" 
                                      maxlength="@donationSettings.MaxMessageLength"
                                      placeholder="Gửi lời chúc, động viên đến người nhận..."></textarea>
                            <small class="text-muted"><span id="messageCount">0</span>/@donationSettings.MaxMessageLength ký tự</small>
                        </div>

                        <!-- Quyên góp ẩn danh -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="IsAnonymous" id="isAnonymous" value="true">
                                <label class="form-check-label" for="isAnonymous">
                                    Quyên góp ẩn danh (Tên của bạn sẽ không hiển thị công khai)
                                </label>
                            </div>
                        </div>

                        <!-- Phương thức thanh toán - Chỉ MoMo cho môi trường dev -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Phương thức thanh toán <span class="text-danger">*</span></label>
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="form-check payment-method-card">
                                        <input class="form-check-input" type="radio" name="PaymentMethod" id="payMoMo" value="momo" checked>
                                        <label class="form-check-label w-100" for="payMoMo">
                                            <div class="card border-primary">
                                                <div class="card-body d-flex align-items-center">
                                                    <img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" 
                                                         alt="MoMo" style="height: 50px; object-fit: contain;" class="me-3">
                                                    <div>
                                                        <h5 class="mb-1">Ví MoMo</h5>
                                                        <small class="text-muted">Thanh toán nhanh chóng qua ví điện tử MoMo</small>
                                                        <span class="badge bg-info ms-2">Đang test</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="invalid-feedback" id="paymentMethodError"></div>
                        </div>

                        <hr>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn" disabled>
                                <i class="bi bi-heart me-2"></i>Quyên góp với MoMo
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Thông tin hỗ trợ -->
            <div class="card mt-4 border-0 bg-light">
                <div class="card-body">
                    <h6><i class="bi bi-shield-check text-success me-2"></i>Cam kết bảo mật</h6>
                    <p class="small text-muted mb-0">
                        Mọi thông tin quyên góp của bạn được bảo mật tuyệt đối. 
                        Giao dịch được xử lý an toàn qua cổng thanh toán MoMo.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bank Transfer Modal (for future use) -->
<div class="modal fade" id="bankTransferModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-bank me-2"></i>Thông tin chuyển khoản</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bankTransferInfo">
                <!-- Bank info will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
     style="background: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="position-absolute top-50 start-50 translate-middle text-center text-white">
        <div class="spinner-border mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <p>Đang xử lý thanh toán...</p>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const minAmount = @donationSettings.MinAmount;
            const maxAmount = @donationSettings.MaxAmount;
            const maxMessageLength = @donationSettings.MaxMessageLength;

            // Chọn chiến dịch từ danh sách
            $('.campaign-item').on('click', function() {
                const $this = $(this);
                const campaignId = $this.data('campaign-id');
                const title = $this.data('campaign-title');
                const current = $this.data('campaign-current');
                const target = $this.data('campaign-target');
                const percent = $this.data('campaign-percent');

                // Update UI
                $('.campaign-item').removeClass('active');
                $this.addClass('active');

                // Update form
                $('#campaignIdInput').val(campaignId);
                $('#selectedCampaignTitle').text(title);
                $('#selectedCampaignCurrent').text(Number(current).toLocaleString('vi-VN'));
                $('#selectedCampaignTarget').text(Number(target).toLocaleString('vi-VN'));
                $('#selectedCampaignProgress').css('width', percent + '%');

                // Show campaign info, hide warning
                $('#campaignInfoPanel').removeClass('d-none');
                $('#noCampaignMessage').addClass('d-none');

                // Enable submit button if amount is valid
                validateForm();
            });

            // Các nút chọn số tiền nhanh
            $('.amount-btn').on('click', function() {
                const amount = $(this).data('amount');
                $('#amount').val(amount);
                $('.amount-btn').removeClass('btn-primary').addClass('btn-outline-primary');
                $(this).removeClass('btn-outline-primary').addClass('btn-primary');
                validateForm();
            });

            // Validate amount khi nhập
            $('#amount').on('input', function() {
                const amount = parseFloat($(this).val()) || 0;
                $('.amount-btn').removeClass('btn-primary').addClass('btn-outline-primary');
                
                // Highlight matching quick amount button
                $(`.amount-btn[data-amount="${amount}"]`).removeClass('btn-outline-primary').addClass('btn-primary');
                
                validateForm();
            });

            // Đếm ký tự message
            $('#message').on('input', function() {
                const length = $(this).val().length;
                $('#messageCount').text(length);
            });

            // Validate form
            function validateForm() {
                const campaignId = $('#campaignIdInput').val();
                const amount = parseFloat($('#amount').val()) || 0;
                const paymentMethod = $('input[name="PaymentMethod"]:checked').val();

                let isValid = true;
                
                // Check campaign
                if (!campaignId) {
                    isValid = false;
                }

                // Check amount
                if (amount < minAmount || amount > maxAmount) {
                    isValid = false;
                }

                // Check payment method
                if (!paymentMethod) {
                    isValid = false;
                }

                $('#submitBtn').prop('disabled', !isValid);
                return isValid;
            }

            // Submit form
            $('#donationForm').on('submit', function(e) {
                e.preventDefault();

                if (!validateForm()) {
                    return;
                }

                const formData = {
                    CampaignId: parseInt($('#campaignIdInput').val()),
                    Amount: parseFloat($('#amount').val()),
                    Message: $('#message').val(),
                    IsAnonymous: $('#isAnonymous').is(':checked'),
                    PaymentMethod: $('input[name="PaymentMethod"]:checked').val()
                };

                // Show loading
                $('#loadingOverlay').removeClass('d-none');
                $('#submitBtn').prop('disabled', true);

                console.log('Sending donation request:', formData);

                $.ajax({
                    url: '@Url.Action("ProcessDonation", "Donation")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        console.log('Response:', response);
                        if (response.success) {
                            if (response.redirectUrl) {
                                // Redirect to payment gateway (MoMo)
                                console.log('Redirecting to:', response.redirectUrl);
                                window.location.href = response.redirectUrl;
                            } else if (response.paymentMethod === 'bank_transfer') {
                                // Show bank transfer info
                                $('#loadingOverlay').addClass('d-none');
                                showBankTransferModal(response.bankInfo, response.transactionCode);
                            }
                        } else {
                            $('#loadingOverlay').addClass('d-none');
                            $('#submitBtn').prop('disabled', false);
                            
                            // Nếu cần đăng nhập, chuyển đến trang login
                            if (response.requireLogin) {
                                if (confirm(response.message + '\n\nBạn có muốn đăng nhập ngay?')) {
                                    const campaignId = $('#campaignIdInput').val();
                                    const returnUrl = campaignId ? '/donate/' + campaignId : '/donate';
                                    window.location.href = '@Url.Action("Login", "Account")' + '?returnUrl=' + encodeURIComponent(returnUrl);
                                }
                            } else {
                                alert(response.message || 'Có lỗi xảy ra, vui lòng thử lại.');
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', status, error);
                        console.error('Response:', xhr.responseText);
                        $('#loadingOverlay').addClass('d-none');
                        $('#submitBtn').prop('disabled', false);
                        alert('Có lỗi xảy ra, vui lòng thử lại. Chi tiết: ' + error);
                    }
                });
            });

            function showBankTransferModal(bankInfo, transactionCode) {
                const html = `
                    <div class="text-center mb-3">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                        <h5 class="mt-2">Đã tạo giao dịch thành công!</h5>
                    </div>
                    <div class="bg-light p-3 rounded mb-3">
                        <p class="mb-2"><strong>Ngân hàng:</strong> ${bankInfo.bankName}</p>
                        <p class="mb-2"><strong>Số tài khoản:</strong> <span class="text-primary fw-bold">${bankInfo.accountNumber}</span></p>
                        <p class="mb-2"><strong>Tên tài khoản:</strong> ${bankInfo.accountName}</p>
                        <p class="mb-2"><strong>Chi nhánh:</strong> ${bankInfo.branch}</p>
                        <p class="mb-2"><strong>Số tiền:</strong> <span class="text-danger fw-bold">${Number(bankInfo.amount).toLocaleString('vi-VN')} VNĐ</span></p>
                        <p class="mb-0"><strong>Nội dung CK:</strong> <span class="text-primary fw-bold">${bankInfo.transferContent}</span></p>
                    </div>
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <small>Vui lòng ghi đúng nội dung chuyển khoản để giao dịch được xử lý tự động.</small>
                    </div>
                `;
                $('#bankTransferInfo').html(html);
                $('#bankTransferModal').modal('show');
            }

            // Initial validation
            validateForm();

            // ============ Campaign Search & Filter ============
            const $campaignSearch = $('#campaignSearch');
            const $categoryFilter = $('#categoryFilter');
            const $campaignItems = $('.campaign-item');
            const $filteredCount = $('#filteredCount');
            const $noResultsMessage = $('#noResultsMessage');
            const $campaignList = $('#campaignList');
            const totalCampaigns = $campaignItems.length;

            function filterCampaigns() {
                const searchTerm = $campaignSearch.val().toLowerCase().trim();
                const selectedCategory = $categoryFilter.val();
                let visibleCount = 0;

                $campaignItems.each(function() {
                    const $item = $(this);
                    const title = $item.data('campaign-title')?.toString().toLowerCase() || '';
                    const category = $item.data('campaign-category') || '';

                    const matchesSearch = !searchTerm || title.includes(searchTerm);
                    const matchesCategory = !selectedCategory || category === selectedCategory;

                    if (matchesSearch && matchesCategory) {
                        $item.removeClass('d-none');
                        visibleCount++;
                    } else {
                        $item.addClass('d-none');
                    }
                });

                // Update count
                $filteredCount.text(visibleCount);

                // Show/hide no results message
                if (visibleCount === 0 && totalCampaigns > 0) {
                    $noResultsMessage.removeClass('d-none');
                    $campaignList.addClass('d-none');
                } else {
                    $noResultsMessage.addClass('d-none');
                    $campaignList.removeClass('d-none');
                }
            }

            // Search input with debounce
            let searchTimeout;
            $campaignSearch.on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(filterCampaigns, 200);
            });

            // Category filter
            $categoryFilter.on('change', filterCampaigns);

            // Clear search button
            $('#clearSearch').on('click', function() {
                $campaignSearch.val('');
                filterCampaigns();
                $campaignSearch.focus();
            });

            // Reset filters
            $('#resetFilters, #clearFiltersBtn').on('click', function() {
                $campaignSearch.val('');
                $categoryFilter.val('');
                filterCampaigns();
            });

            // Highlight search term in campaign title
            function highlightSearchTerm() {
                const searchTerm = $campaignSearch.val().trim();
                $campaignItems.each(function() {
                    const $item = $(this);
                    const $titleEl = $item.find('.campaign-title-text');
                    const originalTitle = $item.data('campaign-title');
                    
                    if (searchTerm && originalTitle.toLowerCase().includes(searchTerm.toLowerCase())) {
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        const highlighted = originalTitle.replace(regex, '<mark>$1</mark>');
                        $titleEl.html(highlighted);
                    } else {
                        $titleEl.text(originalTitle);
                    }
                });
            }

            $campaignSearch.on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    filterCampaigns();
                    highlightSearchTerm();
                }, 200);
            });
        });
    </script>
}

<style>
    .payment-method-card .form-check-input {
        display: none;
    }
    
    .payment-method-card .form-check-input:checked + .form-check-label .card {
        border-color: #198754 !important;
        border-width: 2px;
        background-color: #f8fff8;
    }
    
    .campaign-item.active {
        background-color: #0d6efd;
        color: white;
    }
    
    .campaign-item:hover:not(.active) {
        background-color: #f8f9fa;
    }
    
    .amount-btn {
        font-weight: 600;
    }
    
    /* Campaign search & filter styles */
    #campaignListContainer {
        scrollbar-width: thin;
        scrollbar-color: #ccc #f8f9fa;
    }
    
    #campaignListContainer::-webkit-scrollbar {
        width: 6px;
    }
    
    #campaignListContainer::-webkit-scrollbar-track {
        background: #f8f9fa;
    }
    
    #campaignListContainer::-webkit-scrollbar-thumb {
        background-color: #ccc;
        border-radius: 3px;
    }
    
    #campaignListContainer::-webkit-scrollbar-thumb:hover {
        background-color: #aaa;
    }
    
    .campaign-item.d-none {
        display: none !important;
    }
    
    .campaign-title-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .campaign-title-text mark {
        background-color: #fff3cd;
        padding: 0 2px;
        border-radius: 2px;
    }
    
    #clearSearch {
        border-left: none;
    }
    
    #clearSearch:hover {
        background-color: #e9ecef;
    }
</style>
