@using TuThien.Configuration
@{
    ViewData["Title"] = "Quyên góp";
    var campaign = ViewBag.Campaign as TuThien.Models.Campaign;
    var donationSettings = ViewBag.DonationSettings as DonationSettings ?? new DonationSettings();
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="bi bi-heart-fill me-2"></i>Quyên góp cho chiến dịch</h4>
                </div>
                <div class="card-body">
                    <!-- Campaign Info -->
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading">@campaign?.Title</h5>
                        <p class="mb-1">Đã quyên góp: <strong>@((campaign?.CurrentAmount ?? 0).ToString("N0")) VNĐ</strong> / @((campaign?.TargetAmount ?? 0).ToString("N0")) VNĐ</p>
                        <div class="progress" style="height: 10px;">
                            @{
                                var percent = campaign?.TargetAmount > 0 
                                    ? Math.Min(100, (double)((campaign?.CurrentAmount ?? 0) / campaign.TargetAmount) * 100) 
                                    : 0;
                            }
                            <div class="progress-bar bg-success" style="width: @percent%"></div>
                        </div>
                    </div>

                    <form id="donationForm" novalidate>
                        <input type="hidden" name="CampaignId" value="@campaign?.CampaignId" />
                        
                        <!-- Số tiền quyên góp -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Số tiền quyên góp <span class="text-danger">*</span></label>
                            <div class="row g-2 mb-3">
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="50000">50,000</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="100000">100,000</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="200000">200,000</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="500000">500,000</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="1000000">1,000,000</button>
                                </div>
                                <div class="col-4">
                                    <button type="button" class="btn btn-outline-primary w-100 amount-btn" data-amount="2000000">2,000,000</button>
                                </div>
                            </div>
                            <div class="input-group">
                                <input type="number" class="form-control form-control-lg" name="Amount" id="amount" 
                                       placeholder="Nhập số tiền khác..." 
                                       min="@donationSettings.MinAmount" 
                                       max="@donationSettings.MaxAmount" 
                                       step="1000"
                                       required />
                                <span class="input-group-text">VNĐ</span>
                            </div>
                            <div class="invalid-feedback" id="amountError"></div>
                            <small class="text-muted">Số tiền quyên góp từ @donationSettings.MinAmount.ToString("N0") đến @donationSettings.MaxAmount.ToString("N0") VNĐ</small>
                        </div>

                        <!-- Lời nhắn -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Lời nhắn (không bắt buộc)</label>
                            <textarea class="form-control" name="Message" id="message" rows="3" 
                                      maxlength="@donationSettings.MaxMessageLength"
                                      placeholder="Gửi lời chúc, động viên đến người nhận..."></textarea>
                            <div class="invalid-feedback" id="messageError"></div>
                            <small class="text-muted"><span id="messageCount">0</span>/@donationSettings.MaxMessageLength ký tự</small>
                        </div>

                        <!-- Quyên góp ẩn danh -->
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="IsAnonymous" id="isAnonymous" value="true">
                                <label class="form-check-label" for="isAnonymous">
                                    Quyên góp ẩn danh (Tên của bạn sẽ không hiển thị công khai)
                                </label>
                            </div>
                        </div>

                        <!-- Phương thức thanh toán -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Phương thức thanh toán <span class="text-danger">*</span></label>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-check payment-method-card">
                                        <input class="form-check-input" type="radio" name="PaymentMethod" id="payVNPay" value="vnpay">
                                        <label class="form-check-label w-100" for="payVNPay">
                                            <div class="card h-100 text-center p-3">
                                                <img src="https://vnpay.vn/assets/images/logo-icon/logo-primary.svg" alt="VNPAY" style="height: 40px; object-fit: contain;">
                                                <small class="mt-2">VNPAY</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check payment-method-card">
                                        <input class="form-check-input" type="radio" name="PaymentMethod" id="payMoMo" value="momo">
                                        <label class="form-check-label w-100" for="payMoMo">
                                            <div class="card h-100 text-center p-3">
                                                <img src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" alt="MoMo" style="height: 40px; object-fit: contain;">
                                                <small class="mt-2">MoMo</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check payment-method-card">
                                        <input class="form-check-input" type="radio" name="PaymentMethod" id="payBank" value="bank_transfer" checked>
                                        <label class="form-check-label w-100" for="payBank">
                                            <div class="card h-100 text-center p-3">
                                                <i class="bi bi-bank2" style="font-size: 40px; color: #0d6efd;"></i>
                                                <small class="mt-2">Chuyển khoản</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="invalid-feedback" id="paymentMethodError"></div>
                        </div>

                        <hr>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                <i class="bi bi-heart me-2"></i>Quyên góp ngay
                            </button>
                            <a href="@Url.Action("Details", "TrangChu", new { id = campaign?.CampaignId })" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Quay lại chiến dịch
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bank Transfer Modal -->
<div class="modal fade" id="bankTransferModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-bank me-2"></i>Thông tin chuyển khoản</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>Vui lòng chuyển khoản với nội dung bên dưới để hệ thống tự động xác nhận.
                </div>
                <table class="table table-bordered">
                    <tr>
                        <th>Ngân hàng</th>
                        <td id="bankName"></td>
                    </tr>
                    <tr>
                        <th>Số tài khoản</th>
                        <td><code id="accountNumber"></code> <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('accountNumber')"><i class="bi bi-clipboard"></i></button></td>
                    </tr>
                    <tr>
                        <th>Tên tài khoản</th>
                        <td id="accountName"></td>
                    </tr>
                    <tr>
                        <th>Chi nhánh</th>
                        <td id="branch"></td>
                    </tr>
                    <tr>
                        <th>Số tiền</th>
                        <td><strong id="transferAmount"></strong> VNĐ</td>
                    </tr>
                    <tr>
                        <th>Nội dung CK</th>
                        <td><code id="transferContent"></code> <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('transferContent')"><i class="bi bi-clipboard"></i></button></td>
                    </tr>
                </table>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>Sau khi chuyển khoản, hệ thống sẽ tự động xác nhận trong vòng 5-15 phút.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <a href="@Url.Action("Details", "TrangChu", new { id = campaign?.CampaignId })" class="btn btn-primary">Quay lại chiến dịch</a>
            </div>
        </div>
    </div>
</div>

<style>
    .payment-method-card input[type="radio"] {
        display: none;
    }
    .payment-method-card input[type="radio"]:checked + label .card {
        border: 2px solid #198754;
        background-color: #d1e7dd;
    }
    .payment-method-card .card {
        cursor: pointer;
        transition: all 0.3s;
    }
    .payment-method-card .card:hover {
        border-color: #198754;
    }
    .amount-btn.active {
        background-color: #0d6efd;
        color: white;
    }
</style>

<script>
    // Configuration từ server
    const config = {
        minAmount: @donationSettings.MinAmount,
        maxAmount: @donationSettings.MaxAmount,
        maxMessageLength: @donationSettings.MaxMessageLength
    };

    // Validation functions
    const validation = {
        validateAmount: function(amount) {
            const errors = [];
            if (!amount || isNaN(amount)) {
                errors.push('Vui lòng nhập số tiền quyên góp');
            } else {
                if (amount < config.minAmount) {
                    errors.push(`Số tiền quyên góp tối thiểu là ${config.minAmount.toLocaleString('vi-VN')} VNĐ`);
                }
                if (amount > config.maxAmount) {
                    errors.push(`Số tiền quyên góp tối đa là ${config.maxAmount.toLocaleString('vi-VN')} VNĐ`);
                }
                if (amount % 1000 !== 0) {
                    errors.push('Số tiền quyên góp phải là bội số của 1,000 VNĐ');
                }
            }
            return errors;
        },

        validateMessage: function(message) {
            const errors = [];
            if (message && message.length > config.maxMessageLength) {
                errors.push(`Lời nhắn không được vượt quá ${config.maxMessageLength} ký tự`);
            }
            return errors;
        },

        validatePaymentMethod: function(method) {
            const errors = [];
            const validMethods = ['vnpay', 'momo', 'bank_transfer'];
            if (!method || !validMethods.includes(method.toLowerCase())) {
                errors.push('Vui lòng chọn phương thức thanh toán hợp lệ');
            }
            return errors;
        },

        showError: function(inputId, errorId, errors) {
            const input = document.getElementById(inputId);
            const errorDiv = document.getElementById(errorId);
            if (errors.length > 0) {
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
                errorDiv.textContent = errors.join('. ');
                errorDiv.style.display = 'block';
                return false;
            } else {
                input.classList.remove('is-invalid');
                input.classList.add('is-valid');
                errorDiv.style.display = 'none';
                return true;
            }
        },

        validateAll: function() {
            const amount = parseFloat(document.getElementById('amount').value);
            const message = document.getElementById('message').value;
            const paymentMethod = document.querySelector('input[name="PaymentMethod"]:checked')?.value;

            let isValid = true;
            
            isValid = this.showError('amount', 'amountError', this.validateAmount(amount)) && isValid;
            isValid = this.showError('message', 'messageError', this.validateMessage(message)) && isValid;
            
            const paymentErrors = this.validatePaymentMethod(paymentMethod);
            if (paymentErrors.length > 0) {
                document.getElementById('paymentMethodError').textContent = paymentErrors.join('. ');
                document.getElementById('paymentMethodError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('paymentMethodError').style.display = 'none';
            }

            return isValid;
        }
    };

    // Chọn số tiền nhanh
    document.querySelectorAll('.amount-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.amount-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const amountInput = document.getElementById('amount');
            amountInput.value = this.dataset.amount;
            // Trigger validation
            validation.showError('amount', 'amountError', validation.validateAmount(parseFloat(this.dataset.amount)));
        });
    });

    // Real-time validation for amount
    document.getElementById('amount').addEventListener('input', function() {
        validation.showError('amount', 'amountError', validation.validateAmount(parseFloat(this.value)));
    });

    // Real-time validation for message with character count
    document.getElementById('message').addEventListener('input', function() {
        const count = this.value.length;
        document.getElementById('messageCount').textContent = count;
        validation.showError('message', 'messageError', validation.validateMessage(this.value));
    });

    // Submit form
    document.getElementById('donationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Client-side validation
        if (!validation.validateAll()) {
            Swal.fire({
                icon: 'warning',
                title: 'Thông tin chưa hợp lệ',
                text: 'Vui lòng kiểm tra lại các trường dữ liệu',
                confirmButtonColor: '#ffc107'
            });
            return;
        }

        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';

        const formData = new FormData(this);
        const isAnonymous = formData.get('IsAnonymous') === 'true';
        formData.set('IsAnonymous', isAnonymous);

        try {
            const response = await fetch('@Url.Action("ProcessDonation", "Donation")', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                if (result.paymentMethod === 'bank_transfer') {
                    // Hiển thị thông tin chuyển khoản bằng SweetAlert2
                    Swal.fire({
                        icon: 'info',
                        title: 'Thông tin chuyển khoản',
                        html: `
                            <div class="text-start">
                                <table class="table table-bordered mb-3">
                                    <tr><th width="40%">Ngân hàng</th><td><strong>${result.bankInfo.bankName}</strong></td></tr>
                                    <tr><th>Số tài khoản</th><td><code class="fs-6">${result.bankInfo.accountNumber}</code></td></tr>
                                    <tr><th>Tên TK</th><td>${result.bankInfo.accountName}</td></tr>
                                    <tr><th>Chi nhánh</th><td>${result.bankInfo.branch}</td></tr>
                                    <tr><th>Số tiền</th><td class="text-danger fw-bold">${new Intl.NumberFormat('vi-VN').format(result.bankInfo.amount)} VNĐ</td></tr>
                                    <tr><th>Nội dung CK</th><td><code class="fs-6 text-primary">${result.bankInfo.transferContent}</code></td></tr>
                                </table>
                                <div class="alert alert-warning mb-0">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <small>Sau khi chuyển khoản, hệ thống sẽ tự động xác nhận trong vòng 5-15 phút.</small>
                                </div>
                            </div>
                        `,
                        confirmButtonText: 'Đã hiểu',
                        confirmButtonColor: '#198754',
                        width: 500
                    }).then(() => {
                        window.location.href = '@Url.Action("Details", "TrangChu", new { id = campaign?.CampaignId })';
                    });
                } else if (result.redirectUrl) {
                    // Thông báo chuyển hướng
                    Swal.fire({
                        icon: 'success',
                        title: 'Đang chuyển hướng...',
                        text: 'Bạn sẽ được chuyển đến cổng thanh toán',
                        timer: 2000,
                        timerProgressBar: true,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = result.redirectUrl;
                    });
                }
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: result.message || 'Đã xảy ra lỗi',
                    confirmButtonColor: '#dc3545'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Lỗi kết nối',
                text: 'Đã xảy ra lỗi, vui lòng thử lại sau',
                confirmButtonColor: '#dc3545'
            });
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });

    function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).textContent;
        navigator.clipboard.writeText(text).then(() => {
            Swal.fire({
                icon: 'success',
                title: 'Đã sao chép!',
                text: text,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000
            });
        });
    }
</script>
