@model List<TuThien.Models.Donation>
@{
    ViewData["Title"] = "Quyên góp của tôi";
}

<div class="container py-5">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center py-4">
                    <div class="avatar-lg bg-primary bg-opacity-10 text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                        @Context.Session.GetString("Username")?[0].ToString().ToUpper()
                    </div>
                    <h5 class="mb-1">@Context.Session.GetString("Username")</h5>
                    <p class="text-muted small mb-0">@Context.Session.GetString("Email")</p>
                </div>
                <div class="list-group list-group-flush">
                    <a href="@Url.Action("Profile", "Account")" class="list-group-item list-group-item-action">
                        <i class="bi bi-person me-2"></i>Tài khoản của tôi
                    </a>
                    <a href="/my-campaigns" class="list-group-item list-group-item-action">
                        <i class="bi bi-heart me-2"></i>Chiến dịch của tôi
                    </a>
                    <a href="/my-donations" class="list-group-item list-group-item-action active">
                        <i class="bi bi-gift me-2"></i>Quyên góp của tôi
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Stats -->
            <div class="row g-3 mb-4">
                <div class="col-6 col-md-3">
                    <div class="card border-0 shadow-sm text-center py-3">
                        <div class="display-6 text-primary fw-bold">@ViewBag.TotalDonations</div>
                        <small class="text-muted">Tổng lượt</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card border-0 shadow-sm text-center py-3">
                        <div class="display-6 text-success fw-bold">@ViewBag.SuccessfulDonations</div>
                        <small class="text-muted">Thành công</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card border-0 shadow-sm text-center py-3">
                        <div class="display-6 text-info fw-bold">@(((decimal)ViewBag.TotalAmount / 1000000).ToString("N1"))M</div>
                        <small class="text-muted">Đã quyên góp</small>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="card border-0 shadow-sm text-center py-3">
                        <div class="display-6 text-warning fw-bold">@ViewBag.CampaignsSupported</div>
                        <small class="text-muted">Chiến dịch</small>
                    </div>
                </div>
            </div>

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">
                    <i class="bi bi-gift-fill text-success me-2"></i>Lịch sử quyên góp
                </h4>
                <a href="/donate" class="btn btn-success">
                    <i class="bi bi-plus-lg me-1"></i>Quyên góp ngay
                </a>
            </div>

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle me-2"></i>@TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (Model.Count == 0)
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-heart display-1 text-muted mb-3"></i>
                        <h5>Bạn chưa có giao dịch quyên góp nào</h5>
                        <p class="text-muted mb-4">Hãy đóng góp cho các chiến dịch từ thiện để lan tỏa yêu thương!</p>
                        <a href="@Url.Action("Index", "Campaign")" class="btn btn-success">
                            <i class="bi bi-search me-1"></i>Khám phá chiến dịch
                        </a>
                    </div>
                </div>
            }
            else
            {
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Mã GD</th>
                                    <th>Chiến dịch</th>
                                    <th class="text-end">Số tiền</th>
                                    <th>Phương thức</th>
                                    <th>Trạng thái</th>
                                    <th>Thời gian</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var donation in Model)
                                {
                                    var statusBadge = donation.PaymentStatus switch
                                    {
                                        "success" => "bg-success",
                                        "pending" => "bg-warning text-dark",
                                        "failed" => "bg-danger",
                                        _ => "bg-secondary"
                                    };
                                    var statusText = donation.PaymentStatus switch
                                    {
                                        "success" => "Thành công",
                                        "pending" => "Đang xử lý",
                                        "failed" => "Thất bại",
                                        _ => donation.PaymentStatus
                                    };
                                    var methodText = donation.PaymentMethod switch
                                    {
                                        "momo" => "MoMo",
                                        "vnpay" => "VNPay",
                                        "bank_transfer" => "Chuyển khoản",
                                        _ => donation.PaymentMethod
                                    };
                                    var methodBadge = donation.PaymentMethod switch
                                    {
                                        "momo" => "bg-danger",
                                        "vnpay" => "bg-info",
                                        _ => "bg-primary"
                                    };
                                    
                                    <tr>
                                        <td>
                                            <code class="small">@(donation.TransactionCode ?? "-")</code>
                                        </td>
                                        <td>
                                            <a href="@Url.Action("Details", "Campaign", new { id = donation.CampaignId })" class="text-decoration-none">
                                                <span class="text-truncate d-inline-block" style="max-width: 200px;" title="@donation.Campaign?.Title">
                                                    @donation.Campaign?.Title
                                                </span>
                                            </a>
                                            @if (donation.IsAnonymous == true)
                                            {
                                                <br/><small class="text-muted"><i class="bi bi-incognito me-1"></i>Quyên góp ẩn danh</small>
                                            }
                                        </td>
                                        <td class="text-end">
                                            <span class="fw-semibold text-success">@donation.Amount.ToString("N0")đ</span>
                                        </td>
                                        <td>
                                            <span class="badge @methodBadge">@methodText</span>
                                        </td>
                                        <td>
                                            <span class="badge @statusBadge">@statusText</span>
                                        </td>
                                        <td>
                                            <small class="text-muted">@donation.DonatedAt?.ToString("dd/MM/yyyy HH:mm")</small>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Summary -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-body">
                        <h6 class="text-muted mb-3"><i class="bi bi-bar-chart me-2"></i>Tổng quan quyên góp</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="border-end">
                                    <div class="h4 text-success mb-1">@(((decimal)ViewBag.TotalAmount).ToString("N0"))đ</div>
                                    <small class="text-muted">Tổng tiền quyên góp</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border-end">
                                    <div class="h4 text-primary mb-1">@ViewBag.CampaignsSupported</div>
                                    <small class="text-muted">Chiến dịch đã hỗ trợ</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="h4 text-info mb-1">
                                    @if (ViewBag.SuccessfulDonations > 0)
                                    {
                                        @(((decimal)ViewBag.TotalAmount / ViewBag.SuccessfulDonations).ToString("N0"))
                                    }
                                    else
                                    {
                                        @:0
                                    }đ
                                </div>
                                <small class="text-muted">Trung bình/lượt</small>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .avatar-lg {
        font-weight: 600;
    }
    .list-group-item.active {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }
</style>
